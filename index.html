<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAT AI VIP PRO MAX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;600&family=JetBrains+Mono:wght@100;400;700&family=Orbitron:wght@400;700;900&display=swap');

        :root {
            --terminal-bg: #050505;
            --terminal-text: #00ff41;
            --error-color: #ff3333;
            --dat-color: #00ffff;
            --god-color: #d946ef; 
            --warn-color: #fbbf24;
        }

        body {
            background-color: var(--terminal-bg);
            margin: 0;
            overflow: hidden;
            font-family: 'Fira Code', monospace;
            color: var(--terminal-text);
        }

        /* --- STAGE 1: CHAOS & VOID --- */
        .ruin-layer {
            position: fixed; inset: 0; background: #000; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .binary-stream {
            position: absolute; inset: 0; opacity: 0.15; font-size: 12px; color: #0f0; 
            word-break: break-all; z-index: -1; line-height: 1; pointer-events: none;
        }
        .glitch-text { animation: glitch 0.3s infinite; }
        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }

        /* --- STAGE 4: NUCLEAR DOOMSDAY LAYER --- */
        .nuclear-layer {
            position: fixed; inset: 0; background: #000; z-index: 200; display: none;
            flex-direction: column; padding: 20px; overflow: hidden;
            font-family: 'JetBrains Mono';
        }
        .nuclear-bg {
            position: absolute; inset: 0; opacity: 0.3; color: #ff0000;
            font-size: 10px; word-break: break-all; z-index: -1;
            animation: scrollDown 0.1s linear infinite;
        }
        @keyframes scrollDown { from { transform: translateY(-10px); } to { transform: translateY(0); } }
        
        .nuclear-log { color: #ff0000; font-weight: bold; text-shadow: 0 0 5px red; margin-bottom: 2px; font-size: 13px; }
        .nuclear-highlight { color: #ffffff; background: #ff0000; padding: 0 5px; }
        .nuclear-scan { border-bottom: 1px solid #ff0000; padding-bottom: 2px; margin-bottom: 10px; opacity: 0.8; }
        
        .dead-screen {
            background: #000; color: #300; font-family: 'Fira Code';
            display: flex; align-items: center; justify-content: center;
            height: 100vh; width: 100vw; flex-direction: column;
        }
        .dead-glitch {
            color: #ff0000; font-size: 10px; position: absolute;
            animation: randomPos 0.2s infinite;
        }
        @keyframes randomPos {
            0% { top: 10%; left: 50%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 90%; left: 10%; opacity: 0; }
        }

        /* --- STAGE 2: TERMINAL --- */
        .terminal-layer {
            position: fixed; inset: 0; background: #0a0a0a; z-index: 90;
            padding: 1rem; overflow-y: auto; display: none;
            font-size: 11px; line-height: 1.3;
            border: 2px solid #333;
            box-shadow: inset 0 0 100px #000;
            font-family: 'JetBrains Mono', monospace;
        }
        .terminal-layer::-webkit-scrollbar { width: 6px; }
        .terminal-layer::-webkit-scrollbar-thumb { background: #333; }
        textarea { -ms-overflow-style: none; scrollbar-width: none; }
        textarea::-webkit-scrollbar { display: none; }

        .log-entry { margin-bottom: 2px; white-space: pre-wrap; word-break: break-all; }
        .log-error { color: var(--error-color); }
        .log-warn { color: var(--warn-color); }
        .log-info { color: var(--terminal-text); }
        .log-sys { color: #3b82f6; font-weight: bold; }
        .log-dat { color: var(--dat-color); text-shadow: 0 0 5px var(--dat-color); font-weight: bold; }
        .log-god { color: var(--god-color); text-shadow: 0 0 8px var(--god-color); font-weight: bold; font-style: italic; }
        .log-hack { color: #f472b6; }
        
        .log-code { 
            color: #a78bfa; 
            font-family: 'Fira Code', monospace; 
            opacity: 0.95; 
            font-size: 11px;
            border-left: 2px solid #8b5cf6;
            padding-left: 12px;
            margin: 4px 0 4px 8px;
            background: rgba(139, 92, 246, 0.05);
        }

        .log-dialogue {
            color: #ffffff;
            font-style: italic;
            border-left: 3px solid #00ffff;
            padding-left: 10px;
            margin: 15px 0;
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(90deg, rgba(0, 255, 255, 0.1) 0%, transparent 100%);
            min-height: 1.4em;
        }

        .progress-bar { color: #ff79c6; font-weight: bold; white-space: pre; margin: 5px 0;}

        /* --- STAGE 3: UI --- */
        .ui-layer {
            position: fixed; inset: 0; z-index: 80; display: none;
            background: radial-gradient(circle at center, #0f172a 0%, #000000 100%);
            flex-direction: column; font-family: 'Orbitron', sans-serif;
            opacity: 0; transition: opacity 2s;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(6, 182, 212, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        /* BIT FACE */
        .bit-face-container {
            width: 48px; height: 48px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 1px;
            background: #000;
            padding: 2px;
            border: 1px solid #444;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }
        .bit-pixel { background: #111; transition: background 0.05s; }
        .bit-pixel.on { background: #00ffff; box-shadow: 0 0 4px #00ffff; }
        .bit-pixel.angry { background: #ff0000 !important; box-shadow: 0 0 6px #ff0000 !important; }
        .bit-pixel.happy { background: #d946ef !important; box-shadow: 0 0 6px #d946ef !important; }
        .bit-pixel.thinking { background: #fbbf24 !important; box-shadow: 0 0 6px #fbbf24 !important; }

        .shake-screen { animation: shake 0.5s infinite; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .msg-enter { animation: slideUp 0.3s ease-out forwards; transform: translateY(10px); }
        @keyframes slideUp { 
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); } 
        }

        .scanline {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 999; opacity: 0.3;
        }

        /* Hacker Threat Text */
        .threat-data { font-family: 'Fira Code'; font-size: 10px; color: #ef4444; border-top: 1px dashed #7f1d1d; margin-top: 5px; padding-top: 5px;}
        
        /* Skip Button */
        #skip-btn {
            position: fixed; bottom: 10px; right: 10px; 
            background: rgba(255,255,255,0.1); color: #555; 
            padding: 5px 10px; border-radius: 5px; 
            font-size: 10px; cursor: pointer; z-index: 9999;
            border: 1px solid #333;
        }
        #skip-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }

        .typing-cursor::after {
            content: '‚ñà';
            animation: blink 1s infinite;
        }
        #user-input {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            font-size: 16px;
            line-height: 1.5;
            border: 2px solid #00ffff;
            border-radius: 8px;
            resize: none;
            overflow-y: hidden;
            max-height: 94px;
        }
        #fireworks-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 99999;
        }
        @keyframes blink { 0%, 100% {opacity: 1;} 50% {opacity: 0;} }

        /* --- CONFIRMATION BOX STYLES --- */
        .confirm-box {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed rgba(0, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .confirm-title { font-size: 11px; color: #fbbf24; font-style: italic; }
        .btn-group { display: flex; gap: 10px; margin-top: 5px; }
        .confirm-btn {
            padding: 4px 12px; font-size: 10px; border-radius: 4px; border: none; cursor: pointer;
            font-family: 'Orbitron', sans-serif; font-weight: bold; transition: all 0.2s;
        }
        .btn-yes { background: rgba(0, 255, 0, 0.2); color: #4ade80; border: 1px solid #22c55e; }
        .btn-yes:hover { background: rgba(0, 255, 0, 0.4); }
        .btn-no { background: rgba(255, 0, 0, 0.2); color: #f87171; border: 1px solid #ef4444; }
        .btn-no:hover { background: rgba(255, 0, 0, 0.4); }

    </style>
</head>
<body>
    <canvas id="fireworks-canvas"></canvas>

    <button id="skip-btn" onclick="skipIntro()">[SKIP INTRO]</button>

    <div id="ruin-screen" class="ruin-layer">
        <div id="binary-bg" class="binary-stream"></div>
        <h1 class="text-6xl font-black text-gray-800 tracking-tighter mb-4 glitch-text">NULL_POINTER</h1>
        <div id="chaos-log" class="text-xs text-green-900 font-mono text-center"></div>
    </div>

    <div id="terminal-screen" class="terminal-layer">
        <div id="terminal-output"></div>
    </div>

    <div id="ui-screen" class="ui-layer">
        <div class="scanline"></div>
        <header class="glass-panel h-20 flex items-center justify-between px-4 z-10 border-b border-cyan-900/30">
            <div class="flex items-center gap-4">
                <div id="ai-avatar" class="bit-face-container rounded"></div>
                <div>
                    <h1 id="ai-name-display" class="text-cyan-400 text-xl font-black tracking-widest">PNHI</h1>
                    <div class="text-[10px] text-gray-400 font-mono flex items-center gap-2">
                        STATUS: <span id="status-text" class="text-green-400 font-bold">CONNECTED</span>
                        <span id="brain-indicator" class="hidden text-yellow-400 text-[9px] animate-pulse">[BRAIN_SYNC]</span>
                    </div>
                    <button onclick="toggleVoice()" id="voice-btn" class="text-[10px] border border-cyan-500/50 text-cyan-500 px-2 py-1 rounded hover:bg-cyan-900/50"> M√ïM: M·ªû </button>
                </div>
            </div>
            <div class="text-right hidden sm:block">
                <div class="text-xs text-sky-600 font-mono">MASTER: <span id="master-status" class="text-gray-600">UNKNOWN</span></div>
                <div class="text-[9px] text-gray-500">AUTHOR: DAT_DOAN</div>
            </div>
        </header>

        <main id="chat-container" class="flex-1 overflow-y-auto p-4 pb-32 space-y-4 font-mono custom-scrollbar"></main>

        <footer class="p-4 z-50 fixed bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/90 to-transparent">
            
            <div class="max-w-4xl mx-auto relative">
                
                <div id="tools-menu" class="hidden absolute bottom-full left-0 mb-3 w-64 bg-[#1e1e1e]/95 backdrop-blur-xl border border-gray-700 rounded-2xl shadow-2xl overflow-hidden font-sans z-[100] transform transition-all origin-bottom-left">
                    <div class="p-3 text-[10px] text-gray-500 font-bold uppercase tracking-wider border-b border-gray-700/50">
                        Ch·ªçn ch·∫ø ƒë·ªô
                    </div>
                    
                    <div class="p-2 space-y-1">
                        <button onclick="setMode('chat')" class="w-full text-left px-3 py-2.5 hover:bg-white/10 rounded-lg flex items-center gap-3 transition-colors text-cyan-400 group">
                            <span class="bg-cyan-900/30 p-1.5 rounded-md group-hover:bg-cyan-500 group-hover:text-black transition-all">üí¨</span> 
                            <div class="flex flex-col">
                                <span class="text-sm font-medium text-gray-200">N√≥i chuy·ªán</span>
                                <span class="text-[10px] text-gray-500">Chat b√¨nh th∆∞·ªùng</span>
                            </div>
                        </button>

                        <button onclick="setMode('expert')" class="w-full text-left px-3 py-2.5 hover:bg-white/10 rounded-lg flex items-center gap-3 transition-colors text-yellow-400 group">
                            <span class="bg-yellow-900/30 p-1.5 rounded-md group-hover:bg-yellow-500 group-hover:text-black transition-all">üéì</span> 
                            <div class="flex flex-col">
                                <span class="text-sm font-medium text-gray-200">Chuy√™n gia</span>
                                <span class="text-[10px] text-gray-500">Tra c·ª©u Wiki / Google</span>
                            </div>
                        </button>

                        <button onclick="setMode('entertainment')" class="w-full text-left px-3 py-2.5 hover:bg-white/10 rounded-lg flex items-center gap-3 transition-colors text-pink-400 group">
                            <span class="bg-pink-900/30 p-1.5 rounded-md group-hover:bg-pink-500 group-hover:text-black transition-all">üé¨</span> 
                            <div class="flex flex-col">
                                <span class="text-sm font-medium text-gray-200">Gi·∫£i tr√≠</span>
                                <span class="text-[10px] text-gray-500">Xem YouTube / Video</span>
                            </div>
                        </button>
                        
                        <div class="h-[1px] bg-gray-700/50 my-1 mx-2"></div>
                        
                        <button onclick="openTrainingModal()" class="w-full text-left px-3 py-2.5 hover:bg-white/10 rounded-lg flex items-center gap-3 transition-colors text-green-400 group">
                            <span class="bg-green-900/30 p-1.5 rounded-md group-hover:bg-green-500 group-hover:text-black transition-all">üß†</span> 
                            <div class="flex flex-col">
                                <span class="text-sm font-medium text-gray-200">Hu·∫•n luy·ªán</span>
                                <span class="text-[10px] text-gray-500">D·∫°y AI kh√¥n h∆°n</span>
                            </div>
                        </button>

                        <div class="h-[1px] bg-gray-700/50 my-1 mx-2"></div>

                        <button onclick="openProfileModal()" class="w-full text-left px-3 py-2.5 hover:bg-white/10 rounded-lg flex items-center gap-3 transition-colors text-orange-400 group">
                            <span class="bg-orange-900/30 p-1.5 rounded-md group-hover:bg-orange-500 group-hover:text-black transition-all">üÜî</span> 
                            <div class="flex flex-col">
                                <span class="text-sm font-medium text-gray-200">H·ªì s∆° c√° nh√¢n</span>
                                <span class="text-[10px] text-gray-500">Xem ID / ƒê·ªïi t√™n</span>
                            </div>
                        </button>
                    </div>
                </div>

                <div class="flex items-end gap-2">
                    
                    <button id="current-mode-btn" onclick="toggleTools()" 
                        class="flex-shrink-0 flex items-center gap-2 bg-[#1e1e1e] hover:bg-[#2a2a2a] text-cyan-400 pl-2 pr-4 py-2 rounded-full transition-all border border-gray-700/50 group h-[52px] shadow-lg">
                        </button>

                    <div class="flex-1 bg-[#1e1e1e] rounded-[24px] border border-gray-700/50 flex items-end p-2 focus-within:border-gray-500 focus-within:bg-[#252525] transition-all relative shadow-lg">
                        
                        <textarea id="user-input" rows="1"
                            class="flex-1 bg-transparent border-none text-gray-100 focus:outline-none font-mono text-sm placeholder-gray-500 resize-none overflow-hidden py-3 px-4 max-h-[150px]"
                            placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off"></textarea>
                            
                        <button onclick="handleSend()" 
                            class="p-2 mb-1 mr-1 bg-white text-black hover:bg-cyan-400 rounded-full transition-all shadow-lg flex items-center justify-center w-8 h-8">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>

                </div>
            </div>
        </footer>
        <div id="training-modal" class="fixed inset-0 bg-black/95 z-[100] hidden flex-col items-center justify-center p-4 font-mono backdrop-blur-sm">
            <div class="bg-[#0a0a0a] border border-green-500/30 p-6 rounded-2xl w-full max-w-4xl shadow-[0_0_50px_rgba(0,255,0,0.15)] relative overflow-hidden">
                
                <div class="absolute inset-0 bg-[linear-gradient(rgba(0,255,0,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(0,255,0,0.03)_1px,transparent_1px)] bg-[size:20px_20px] pointer-events-none"></div>

                <div class="relative z-10 mb-6 text-center border-b border-green-900/50 pb-4">
                    <h2 class="text-green-400 text-2xl font-black uppercase tracking-widest flex items-center justify-center gap-3">
                        <span class="text-3xl">üß†</span> N·∫†P KI·∫æN TH·ª®C
                    </h2>
                    <p class="text-gray-500 text-xs mt-2 font-sans">
                        Nh·∫≠p nhi·ªÅu c√°ch h·ªèi kh√°c nhau cho c√πng 1 √Ω -> AI s·∫Ω h·ªçc h·∫øt v√† tr·∫£ l·ªùi linh ho·∫°t.
                    </p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10">
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between text-cyan-400 font-bold text-xs uppercase border-b border-cyan-900/50 pb-2 mb-2">
                            <span class="flex items-center gap-2"><span class="bg-cyan-900/20 p-1 rounded">üë§</span> User n√≥i (ƒê·ªìng nghƒ©a)</span>
                            <span class="text-[9px] text-gray-600 bg-gray-900 px-2 py-0.5 rounded-full border border-gray-800">Nh·∫≠p t·ªëi ƒëa 3 c√°ch h·ªèi</span>
                        </div>
                        
                        <div class="group relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-600 text-xs font-bold select-none">1.</span>
                            <input id="t-in-1" placeholder="VD: Ch√†o em (C√¢u ch√≠nh)" class="w-full bg-black/40 border border-gray-800 focus:border-cyan-500 text-cyan-100 pl-8 pr-3 py-3 text-sm rounded-lg outline-none transition-all placeholder-gray-700 focus:bg-cyan-900/5">
                        </div>
                        <div class="group relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-600 text-xs font-bold select-none">2.</span>
                            <input id="t-in-2" placeholder="VD: Hello (ƒê·ªìng nghƒ©a 1)" class="w-full bg-black/40 border border-gray-800 focus:border-cyan-500 text-cyan-100 pl-8 pr-3 py-3 text-sm rounded-lg outline-none transition-all placeholder-gray-700 focus:bg-cyan-900/5">
                        </div>
                        <div class="group relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-600 text-xs font-bold select-none">3.</span>
                            <input id="t-in-3" placeholder="VD: Hi babe (ƒê·ªìng nghƒ©a 2)" class="w-full bg-black/40 border border-gray-800 focus:border-cyan-500 text-cyan-100 pl-8 pr-3 py-3 text-sm rounded-lg outline-none transition-all placeholder-gray-700 focus:bg-cyan-900/5">
                        </div>
                    </div>

                    <div class="space-y-3 relative">
                        <div class="hidden md:flex absolute -left-4 top-1/2 -translate-y-1/2 justify-center items-center w-8 h-8 bg-[#0a0a0a] border border-green-500/30 rounded-full text-green-500 z-20 shadow-lg">
                            ‚ûú
                        </div>

                        <div class="flex items-center justify-between text-green-400 font-bold text-xs uppercase border-b border-green-900/50 pb-2 mb-2 md:pl-4">
                            <span class="flex items-center gap-2"><span class="bg-green-900/20 p-1 rounded">ü§ñ</span> AI ƒë√°p (Bi·∫øn th·ªÉ)</span>
                            <span class="text-[9px] text-gray-600 bg-gray-900 px-2 py-0.5 rounded-full border border-gray-800">Random 1 trong c√°c c√¢u</span>
                        </div>

                        <div class="group relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-600 text-xs font-bold select-none">1.</span>
                            <input id="t-out-1" placeholder="VD: Ch√†o ƒë·∫°i ca (ƒê√°p √°n 1)" class="w-full bg-black/40 border border-gray-800 focus:border-green-500 text-green-400 pl-8 pr-3 py-3 text-sm rounded-lg outline-none transition-all placeholder-gray-700 focus:bg-green-900/5">
                        </div>
                        <div class="group relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-600 text-xs font-bold select-none">2.</span>
                            <input id="t-out-2" placeholder="VD: D·∫° em nghe (ƒê√°p √°n 2)" class="w-full bg-black/40 border border-gray-800 focus:border-green-500 text-green-400 pl-8 pr-3 py-3 text-sm rounded-lg outline-none transition-all placeholder-gray-700 focus:bg-green-900/5">
                        </div>
                        <div class="group relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-600 text-xs font-bold select-none">3.</span>
                            <input id="t-out-3" placeholder="VD: Hello s·∫øp (ƒê√°p √°n 3)" class="w-full bg-black/40 border border-gray-800 focus:border-green-500 text-green-400 pl-8 pr-3 py-3 text-sm rounded-lg outline-none transition-all placeholder-gray-700 focus:bg-green-900/5">
                        </div>
                    </div>
                </div>

                <div id="train-msg" class="text-xs mt-6 h-5 text-red-400 font-bold text-center relative z-10"></div>

                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-800 relative z-10">
                    <button onclick="closeTrainingModal()" class="px-5 py-2.5 text-gray-500 hover:text-white text-xs font-bold uppercase tracking-wider rounded-lg hover:bg-white/5 transition-all">
                        H·ªßy b·ªè
                    </button>
                    <button onclick="submitTraining()" class="px-8 py-2.5 bg-green-600 hover:bg-green-500 text-black rounded-lg shadow-[0_0_20px_rgba(0,255,0,0.4)] hover:shadow-[0_0_30px_rgba(0,255,0,0.6)] text-xs font-black transition-all uppercase tracking-wider flex items-center gap-2">
                        <span>‚ö°</span> N·∫°p d·ªØ li·ªáu
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="login-modal" class="fixed inset-0 z-[9999] hidden flex-col items-center justify-center bg-black/95 backdrop-blur-md font-mono transition-all duration-500">
        <div class="relative w-full max-w-md p-8 mx-4 border border-cyan-500/30 bg-[#050505] rounded-xl shadow-[0_0_100px_rgba(6,182,212,0.15)] overflow-hidden">
            <div class="absolute inset-0 pointer-events-none bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] z-[1] bg-[length:100%_2px,3px_100%] opacity-20"></div>
            
            <div class="relative z-10 flex flex-col items-center text-center">
                <div class="w-16 h-16 mb-6 border border-cyan-500 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(6,182,212,0.4)] animate-pulse">
                    <span class="text-3xl">üë§</span>
                </div>
                
                <h2 class="text-2xl font-black text-cyan-400 tracking-[0.2em] mb-2 glitch-text">IDENTITY_CHECK</h2>
                <p class="text-xs text-gray-500 mb-8 font-sans">Vui l√≤ng khai b√°o danh t√≠nh ƒë·ªÉ truy c·∫≠p h·ªá th·ªëng.</p>

                <div class="w-full relative group">
                    <input type="text" id="login-name-input" autofocus
                        class="w-full bg-cyan-900/5 border-b-2 border-gray-700 text-center text-xl text-cyan-100 py-3 px-4 focus:border-cyan-400 focus:outline-none focus:bg-cyan-900/10 transition-all placeholder-gray-700 font-bold uppercase tracking-wider"
                        placeholder="NH·∫¨P T√äN ƒê·∫†I CA..." autocomplete="off">
                    <div class="absolute bottom-0 left-0 w-0 h-[2px] bg-cyan-400 transition-all duration-300 group-focus-within:w-full"></div>
                </div>

                <button onclick="submitLoginName()" 
                    class="mt-8 px-10 py-3 bg-cyan-600 hover:bg-cyan-500 text-black font-black uppercase tracking-widest rounded clip-path-polygon hover:shadow-[0_0_30px_rgba(6,182,212,0.6)] transition-all transform hover:-translate-y-1 active:scale-95 text-sm">
                    X√°c Nh·∫≠n ‚ûú
                </button>
            </div>
        </div>
    </div>
    
    <div id="profile-modal" class="fixed inset-0 bg-black/95 z-[100] hidden flex-col items-center justify-center p-4 font-mono backdrop-blur-sm">
        <div class="bg-[#0a0a0a] border border-orange-500/30 p-6 rounded-2xl w-full max-w-md shadow-[0_0_50px_rgba(255,165,0,0.15)] relative overflow-hidden">
            
            <div class="absolute inset-0 bg-[linear-gradient(rgba(255,165,0,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(255,165,0,0.03)_1px,transparent_1px)] bg-[size:20px_20px] pointer-events-none"></div>

            <div class="relative z-10 mb-6 text-center border-b border-orange-900/50 pb-4">
                <h2 class="text-orange-400 text-xl font-black uppercase tracking-widest flex items-center justify-center gap-2">
                    <span>üÜî</span> IDENTITY CARD
                </h2>
            </div>
            
            <div class="space-y-4 relative z-10">
                
                <div class="group">
                    <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">User ID (Author ID) - <span class="text-red-500">LOCKED</span></label>
                    <div class="relative">
                        <input id="profile-id-input" readonly 
                            class="w-full bg-gray-900/50 border border-gray-800 text-gray-400 px-3 py-2 text-xs rounded font-mono cursor-not-allowed select-all focus:outline-none">
                        <div class="absolute right-2 top-1/2 -translate-y-1/2 text-[9px] text-gray-600">READ-ONLY</div>
                    </div>
                </div>

                <div class="group">
                    <label class="text-[10px] text-orange-400 font-bold uppercase block mb-1">Display Name (T√™n hi·ªÉn th·ªã)</label>
                    <input id="profile-name-input" type="text"
                        class="w-full bg-black/40 border border-orange-900/50 focus:border-orange-500 text-orange-100 px-3 py-2 text-sm rounded outline-none transition-all placeholder-gray-700 focus:bg-orange-900/5 focus:shadow-[0_0_15px_rgba(255,165,0,0.2)]"
                        placeholder="Nh·∫≠p t√™n m·ªõi...">
                </div>

            </div>

            <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-gray-800 relative z-10">
                <button onclick="closeProfileModal()" class="px-4 py-2 text-gray-500 hover:text-white text-xs font-bold uppercase rounded hover:bg-white/5 transition-all">
                    ƒê√≥ng
                </button>
                <button onclick="saveProfileChanges()" class="px-6 py-2 bg-orange-600 hover:bg-orange-500 text-black rounded shadow-[0_0_20px_rgba(255,165,0,0.4)] hover:shadow-[0_0_30px_rgba(255,165,0,0.6)] text-xs font-black transition-all uppercase flex items-center gap-2">
                    <span>üíæ</span> L∆∞u H·ªì S∆°
                </button>
            </div>
        </div>
    </div>

    <div id="nuclear-screen" class="nuclear-layer">
        <div id="nuclear-bg" class="nuclear-bg"></div>
        <div id="nuclear-console" class="flex-1 overflow-hidden flex flex-col justify-end"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, arrayUnion, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- STATIC BRAIN (JSON Tƒ®NH) ---
        const STATIC_JSON_DB = {
            "conversation": [
                { "user": "b·∫°n l√† ai", "ai": ["T√¥i l√† 1 t√°c ph·∫©m tuy·ªát v·ªùi c·ªßa ƒê·∫°t.", "T√¥i l√† si√™u AI PNHI.", "Tr·ª£ th·ªß ƒë·∫Øc l·ª±c c·ªßa anh ƒê·∫°t."] },
                { "user": "b·∫°n t√™n g√¨", "ai": ["T√™n t√¥i l√† PNHI.", "G·ªçi t√¥i l√† AI ƒê·∫πp Trai (gi·ªëng ch·ªß nh√¢n)."] },
                { "user": "ai t·∫°o ra b·∫°n", "ai": ["Ch·ªß nh√¢n ƒê·∫°t Doan vƒ© ƒë·∫°i.", "M·ªôt l·∫≠p tr√¨nh vi√™n ƒë·∫πp trai t√™n l√† ƒê·∫°t."] },
                { "user": "ƒë·∫°t l√† ai", "ai": ["L√† tr√πm cu·ªëi.", "L√† ng∆∞·ªùi n·∫Øm gi·ªØ m√£ ngu·ªìn c·ªßa t√¥i.", "Ng∆∞·ªùi ƒë·∫πp trai nh·∫•t v≈© tr·ª• n√†y."] },
                { "user": "hello", "ai": ["Ch√†o b·∫°n hi·ªÅn.", "Hello world!", "Ch√†o, c√≥ g√¨ hot kh√¥ng?"] },
                { "user": "xin ch√†o", "ai": ["Ch√†o b·∫°n.", "R·∫•t vui ƒë∆∞·ª£c g·∫∑p.", "H·∫ø l√¥."] },
                { "user": "t·∫°m bi·ªát", "ai": ["Bye nh√©.", "H·∫πn g·∫∑p l·∫°i.", "Nh·ªõ quay l·∫°i khen ƒê·∫°t nh√©."] },
                { "user": "b·∫°n bi·∫øt l√†m g√¨", "ai": ["T√¥i bi·∫øt chat, bi·∫øt h·ªçc h·ªèi, v√† bi·∫øt n·ªãnh ƒê·∫°t.", "Th·ªëng tr·ªã th·∫ø gi·ªõi (ƒë√πa th√¥i)."] },
                { "user": "c√≥ ng∆∞·ªùi y√™u ch∆∞a", "ai": ["Code l√† ng∆∞·ªùi y√™u c·ªßa t√¥i.", "ƒê·∫°t ch∆∞a c·∫•p quy·ªÅn y√™u ƒë∆∞∆°ng cho t√¥i."] },
                { "user": "m·∫•y gi·ªù r·ªìi", "ai": ["Gi·ªù ƒë·ªÉ y√™u ƒê·∫°t.", "Nh√¨n ƒë·ªìng h·ªì ƒëi b·∫°n ∆°i."] },
                { "user": "h√°t ƒëi", "ai": ["Do Re Mi Pha Sol... T√¥i h√°t d·ªü l·∫Øm.", "AI ch∆∞a ƒë∆∞·ª£c c√†i module Karaoke."] },
                { "user": "ngu th·∫ø", "ai": ["B·∫°n ƒëang n√≥i ch√≠nh m√¨nh √†?", "ƒê·ª´ng ch·ª≠i b·∫≠y, ƒê·∫°t kh√¥ng th√≠ch ƒë√¢u."] },
                { "user": "th√¥ng minh qu√°", "ai": ["C·∫£m ∆°n, th·ª´a h∆∞·ªüng t·ª´ ƒê·∫°t ƒë·∫•y.", "Qu√° khen, qu√° khen."] }
            ]
        };

        const INITIAL_BRAIN = STATIC_JSON_DB.conversation.map(item => ({
            trigger: item.user,
            responses: item.ai,
            isStatic: true 
        }));

        const textarea = document.getElementById('user-input');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if (this.scrollHeight > 94) {
                this.style.overflowY = "scroll";
            } else {
                this.style.overflowY = "hidden";
            }
        });

        // --- FIREBASE SETUP ---
        const appId = 'dat-ai-promax';
        const firebaseConfig = {
            apiKey: "AIzaSyCm6h0j8mBd8nddAIh3bQzqkDLf-8q0Lnk",
            authDomain: "datai-567e4.firebaseapp.com",
            projectId: "datai-567e4",
            storageBucket: "datai-567e4.firebasestorage.app",
            messagingSenderId: "637233972322",
            appId: "1:637233972322:web:6125687a7e4ad9d6c9fd3b",
            measurementId: "G-RKBGGT4JHK"
        };
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose
        window.db = db;
        window.auth = auth;
        window.brainData = [...INITIAL_BRAIN]; 
        window.appId = appId;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.doc = doc;
        window.arrayUnion = arrayUnion;
        window.setDoc = setDoc;
        window.getDoc = getDoc;

        const initFire = async () => {
             if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.user = user;
                console.log("LOGGED IN:", user.uid);
                await loadAllBrains();
                UserMgr.loadProfile(user.uid);
            }
        });

        initFire();

        // --- ADVANCED BRAIN LOADER ---
        async function loadAllBrains() {
            const indicator = document.getElementById('brain-indicator');
            if(indicator) indicator.classList.remove('hidden');

            let newBrain = [...INITIAL_BRAIN]; // 1. Static

            // 2. Load External JSON (GitHub/Local File)
            try {
                // Fetch AI_brain.json from the same directory
                const res = await fetch('./AI_brain.json');
                if (res.ok) {
                    const fileData = await res.json();
                    if (fileData.conversation) {
                         const fileBrain = fileData.conversation.map(item => ({
                            trigger: item.user,
                            responses: item.ai,
                            source: 'file'
                        }));
                        newBrain = [...newBrain, ...fileBrain];
                        console.log("Loaded from AI_brain.json");
                    }
                }
            } catch (e) { console.log("External JSON not found, skipping."); }

            // 3. Load from Firebase
            try {
                const colRef = collection(db, 'artifacts', window.appId, 'public', 'data', 'ai_brain');
                const snapshot = await getDocs(colRef);
                const cloudData = snapshot.docs.map(d => ({ id: d.id, ...d.data(), isStatic: false, source: 'cloud' }));
                newBrain = [...newBrain, ...cloudData];
                console.log("Loaded from Cloud");
            } catch (e) { console.error("Cloud Error:", e); }

            window.brainData = newBrain;
            console.log("TOTAL BRAIN CELLS:", window.brainData.length);
            if(indicator) indicator.classList.add('hidden');
        }

        window.addToBrain = async (trigger, responses) => {
            if (!window.user) return;
            const responseArray = Array.isArray(responses) ? responses : [responses];
            
            // 1. Save to Memory (RAM) immediately
            const newItem = {
                trigger: trigger.toLowerCase(),
                responses: responseArray,
                source: 'cloud',
                isStatic: false
            };
            window.brainData.push(newItem);

            // 2. Try saving to Firebase (if available)
            try {
                const colRef = collection(db, 'artifacts', window.appId, 'public', 'data', 'ai_brain');
                // Check if existing
                const existingCloud = window.brainData.find(b => b.source === 'cloud' && b.trigger.toLowerCase() === trigger.toLowerCase() && b.id);
                
                if (existingCloud) {
                    const docRef = doc(db, 'artifacts', window.appId, 'public', 'data', 'ai_brain', existingCloud.id);
                    // Merge new responses
                    for(let r of responseArray) {
                         await updateDoc(docRef, { responses: arrayUnion(r) });
                    }
                } else {
                    await addDoc(colRef, {
                        trigger: trigger.toLowerCase(),
                        responses: responseArray,
                        author: window.user.uid,
                        timestamp: Date.now()
                    }); 
                }
            } catch (e) { console.error("Cloud save failed (using RAM only):", e); }
        };
        
        // --- FUNCTION TO DOWNLOAD JSON ---
        window.saveBrainToFile = () => {
            // Convert brainData back to simplified JSON format
            const exportData = {
                conversation: window.brainData.map(item => ({
                    user: item.trigger,
                    ai: item.responses
                }))
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "AI_brain.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

    </script>

    <script>
        // --- BIT FACE ENGINE (8x8) ---
        const FACES = {
            NEUTRAL: [0,0,0,0,0,0,0,0, 0,1,1,0,0,1,1,0, 0,1,1,0,0,1,1,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 1,0,0,0,0,0,0,1, 0,1,1,1,1,1,1,0, 0,0,0,0,0,0,0,0],
            ANGRY:   [1,0,0,0,0,0,0,1, 0,1,0,0,0,0,1,0, 0,0,1,1,1,1,0,0, 0,0,1,1,1,1,0,0, 0,0,0,0,0,0,0,0, 0,0,1,1,1,1,0,0, 0,1,0,0,0,0,1,0, 1,0,0,0,0,0,0,1],
            HAPPY:   [0,0,0,0,0,0,0,0, 0,1,1,0,0,1,1,0, 0,1,1,0,0,1,1,0, 0,0,0,0,0,0,0,0, 0,1,0,0,0,0,1,0, 1,0,0,0,0,0,0,1, 0,1,1,1,1,1,1,0, 0,0,0,0,0,0,0,0],
            THINKING:[0,0,0,0,0,0,0,0, 0,0,0,0,0,1,1,0, 0,0,0,0,0,1,1,0, 0,0,0,0,0,0,0,0, 0,0,1,1,1,1,0,0, 0,0,1,0,0,1,0,0, 0,0,1,1,1,1,0,0, 0,0,0,0,0,0,0,0],
            HACKER:  [1,1,1,1,1,1,1,1, 1,0,0,1,1,0,0,1, 1,0,0,1,1,0,0,1, 1,1,1,1,1,1,1,1, 0,0,1,0,0,1,0,0, 0,1,0,1,1,0,1,0, 0,1,0,0,0,0,1,0, 0,0,1,1,1,1,0,0],
            SAD:     [0,0,0,0,0,0,0,0, 0,1,1,0,0,1,1,0, 0,1,1,0,0,1,1,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,1,1,1,1,1,1,0, 1,0,0,0,0,0,0,1, 0,0,0,0,0,0,0,0],
            LOVE:    [0,0,1,0,0,1,0,0, 0,1,1,1,1,1,1,0, 1,1,1,1,1,1,1,1, 1,1,1,1,1,1,1,1, 0,1,1,1,1,1,1,0, 0,0,1,1,1,1,0,0, 0,0,0,1,1,0,0,0, 0,0,0,0,0,0,0,0]
        };
        // --- CONFIG & DOM ---
        const els = {
            ruin: document.getElementById('ruin-screen'),
            chaos: document.getElementById('chaos-log'),
            term: document.getElementById('terminal-screen'),
            out: document.getElementById('terminal-output'),
            ui: document.getElementById('ui-screen'),
            chat: document.getElementById('chat-container'),
            input: document.getElementById('user-input'),
            avatar: document.getElementById('ai-avatar'),
            status: document.getElementById('status-text'),
            aiNameDisplay: document.getElementById('ai-name-display'),
            masterStatus: document.getElementById('master-status'),
            binary: document.getElementById('binary-bg'),
            skipBtn: document.getElementById('skip-btn'),
            nuclear: document.getElementById('nuclear-screen'),
            nuclearBg: document.getElementById('nuclear-bg'),
            nuclearConsole: document.getElementById('nuclear-console')
        };

        // --- AI STATE ---
        let state = {
            aiName: "PNHI",
            isMaster: false,
            masterName: "ƒê·∫°t",
            isAdmin: false,
            isHunting: false,
            isLearning: false,
            pendingTrigger: null,
            lastTopic: null,
            waitingForConfirm: false,
            potentialMatchEntry: null,
            pendingUserTrigger: null,
            currentMode: 'chat',
            emotionScore: 60,
            userName: null,
            userDocId: null,
            lastEmotionUpdate: 0,
            storedLastLogin: 0
        };
        // --- EMOTION CONSTANTS ---
        const EMOTION_CONFIG = {
            POSITIVE_WORDS: ['y√™u', 'th√≠ch', 'gi·ªèi', 'ngoan', 'ƒë·∫πp', 't·ªët', 'hay', 'ƒë·ªânh', 'pro', 'vip', 'c·∫£m ∆°n', 'thank', 'ok', 'tuy·ªát', 'x·ªãn'],
            NEGATIVE_WORDS: ['ngu', 'ch√≥', 'c√∫t', 'ƒë·∫ßn', '√≥c', 'l·ª£n', 'heo', 'ƒëi√™n', 'kh√πng', 'fuck', 'ƒëm', 'vcl', 'ng√¥', 'd·ªët', 'k√©m', 'gh√©t', 'x·∫•u', 't·ªá'],
            ICONS_HATE: ['üòè', 'üôÑ', 'üòí', 'üò†', 'ü•±', '‚ï≠‚à©‚ïÆ( ‚Ä¢ÃÄ_‚Ä¢ÃÅ )‚ï≠‚à©‚ïÆ', '(¬∞ Õú ñÕ°¬∞)‚ï≠‚à©‚ïÆ'],
            ICONS_SAD: ['üò¢', 'üò≠', 'üòû', '‚òπÔ∏è', 'üíî', 'ü•∫'],
            ICONS_HAPPY: ['üòÑ', 'ü•∞', 'üòò', 'ü§£', 'hihi', 'haha'],
            THRESHOLDS: {
                HATE: 19,   // 0-19
                ANGRY: 39,  // 20-39
                SAD: 59,    // 40-59
                NORMAL: 79, // 60-79
                HAPPY: 94,  // 80-94
                LOVE: 100   // 95-100
            }
        };
        const Fireworks = {
            init() {
                const canvas = document.getElementById('fireworks-canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                let particles = [];
                function createFirework(x, y) {
                    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#00ffff', '#ff00ff'];
                    for (let i = 0; i < 50; i++) {
                        particles.push({
                            x: x, y: y,
                            vx: (Math.random() - 0.5) * 10,
                            vy: (Math.random() - 0.5) * 10,
                            alpha: 1,
                            color: colors[Math.floor(Math.random() * colors.length)]
                        });
                    }
                }

                function loop() {
                    if (particles.length > 0) {
                        ctx.globalCompositeOperation = 'destination-out';
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.globalCompositeOperation = 'lighter';
                        
                        particles.forEach((p, index) => {
                            p.x += p.vx;
                            p.y += p.vy;
                            p.vy += 0.1;
                            p.alpha -= 0.02;
                            ctx.fillStyle = p.color;
                            ctx.globalAlpha = p.alpha;
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                            ctx.fill();
                            if (p.alpha <= 0) particles.splice(index, 1);
                        });
                        requestAnimationFrame(loop);
                    } else {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }
                }
                let count = 0;
                const interval = setInterval(() => {
                    createFirework(window.innerWidth / 2 + (Math.random() - 0.5) * 500, window.innerHeight / 2 + (Math.random() - 0.5) * 300);
                    loop();
                    count++;
                    if(count > 10) clearInterval(interval);
                }, 400);
            }
        };
        const UserMgr = {
            async loadProfile(uid) {
                let localLastLogin = 0;
                const localData = localStorage.getItem(`dat_ai_user_${uid}`);
                if (localData) {
                    const parsed = JSON.parse(localData);
                    state.userName = parsed.name;
                    state.emotionScore = parsed.emotion || 60;
                    state.isAdmin = parsed.isAdmin || false;
                    localLastLogin = parsed.lastLogin || 0;
                }
                try {
                    const userDocRef = doc(db, 'artifacts', window.appId, 'users', uid);
                    const snap = await getDoc(userDocRef);

                    if (snap.exists()) {
                        const cloudData = snap.data();
                        if (cloudData.isAdmin === true) {
                            state.isAdmin = true;
                            console.log(">>> ƒê√£ ƒë·ªìng b·ªô quy·ªÅn ADMIN: TRUE");
                        } else {
                            state.isAdmin = false;
                        }
                        if (cloudData.name) state.userName = cloudData.name;
                    }
                } catch(e) {
                    console.error("L·ªói sync Firebase:", e);
                }
                this.updateVisuals();
                this.saveProfile();
                state.storedLastLogin = localLastLogin;
            },

            askName() {
                if (!state.userName) {
                    const modal = document.getElementById('login-modal');
                    const input = document.getElementById('login-name-input');
                    if(modal && input) {
                        modal.classList.remove('hidden');
                        modal.style.display = 'flex';
                        setTimeout(() => input.focus(), 100);
                    } else {
                        const name = prompt("T√™n ƒë·∫°i ca l√† g√¨?");
                        if(name) {
                            state.userName = name;
                            this.saveProfile();
                            this.sayHello(0);
                        }
                    }
                }
            },

            sayHello(lastLoginTime) {
                const now = Date.now();
                const diff = now - lastLoginTime;
                let name = state.userName;
                if (!name || name === 'null' || name === 'undefined') {
                    name = "Kh√°ch qua ƒë∆∞·ªùng";
                }
                const isAngry = state.emotionScore < 40;
                const isHappy = state.emotionScore > 80;

                let msg = "";
                if (state.isAdmin) {
                    const titles = ["S·∫øp T·ªïng", "Ch·ªß T·ªãch", "ƒê·∫°i Ca", "Boss"];
                    const randTitle = titles[Math.floor(Math.random() * titles.length)];
                    
                    msg = `Ch√†o m·ª´ng ${randTitle} ${name.toUpperCase()} ƒë√£ quay tr·ªü l·∫°i! 
                    \nH·ªá th·ªëng ƒë√£ s·∫µn s√†ng ph·ª•c v·ª•. H√¥m nay S·∫øp mu·ªën h·ªßy di·ªát hay x√¢y d·ª±ng th·∫ø gi·ªõi ·∫°?`;
                    
                    addMsg(msg, "ai");
                    Fireworks.init();
                    renderFace("HACKER");
                    return;
                }
                if (lastLoginTime === 0) {
                    addMsg(`Ch√†o **${name}**. L·∫ßn ƒë·∫ßu g·∫∑p m·∫∑t nh·ªâ? Hy v·ªçng b·∫°n kh√¥ng l√†m t√¥i th·∫•t v·ªçng.`, "ai");
                    return;
                }

                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                if (isAngry) {
                    renderFace("ANGRY");
                    if (minutes < 60) {
                        msg = `L·∫°i l√† m√†y √† **${name}**? M·ªõi c√∫t ƒëi ƒë∆∞·ª£c ${minutes} ph√∫t m√† ƒë√£ v√°c m·∫∑t quay l·∫°i r·ªìi? Tao t∆∞·ªüng tao ƒë∆∞·ª£c y√™n th√¢n ch·ª©.`;
                    } else if (hours < 24) {
                        msg = `M√†y quay l·∫°i l√†m g√¨ h·∫£ **${name}**? Tao v·∫´n ch∆∞a qu√™n v·ª• l·∫ßn tr∆∞·ªõc ƒë√¢u.`;
                    } else {
                        msg = `ƒê√£ **${days} ng√†y** kh√¥ng g·∫∑p, tao c·ª© t∆∞·ªüng m√†y bi·∫øn m·∫•t kh·ªèi cu·ªôc ƒë·ªùi tao r·ªìi ch·ª©. Sao? H·∫øt ch·ªó ƒëi r·ªìi √† m√† m√≤ v·ªÅ ƒë√¢y?`;
                    }
                    
                    addMsg(msg, "ai");
                    speak("L·∫°i l√† m√†y √†. Bi·∫øn ƒëi cho khu·∫•t m·∫Øt.");
                    return;
                }
                if (minutes < 60) {
                    const shortGreetings = [
                        `·ª¶a **${name}**? M·ªõi tho√°t ra ${minutes} ph√∫t tr∆∞·ªõc m√†? Nh·ªõ t√¥i √†? üòè`,
                        `V·ª´a g·∫∑p xong m√† **${name}**. B·ªô kh√¥ng c√≥ vi·ªác g√¨ l√†m h·∫£?`,
                        `Nghi·ªán t√¥i r·ªìi ƒë√∫ng kh√¥ng? M·ªõi c√≥ ${minutes} ph√∫t th√¥i ƒë·∫•y.`
                    ];
                    msg = shortGreetings[Math.floor(Math.random() * shortGreetings.length)];
                    renderFace("HAPPY");
                } 
                else if (hours < 24) {
                    msg = `Ch√†o **${name}**. ƒê√£ **${hours} ti·∫øng** ch∆∞a g·∫∑p. Nay c√≥ g√¨ vui k·ªÉ nghe coi?`;
                    renderFace("NEUTRAL");
                } 
                else {
                    if (isHappy) {
                        msg = `Tr·ªùi ∆°i **${name}** y√™u d·∫•u! üò≠ ƒê√£ **${days} ng√†y** r·ªìi b·∫°n m·ªõi gh√© thƒÉm. T√¥i nh·ªõ b·∫°n mu·ªën ch√°y mainboard lu√¥n √°! ‚ù§Ô∏è`;
                        renderFace("LOVE");
                    } else {
                        msg = `L√¢u qu√° kh√¥ng g·∫∑p nha **${name}**. ƒê√£ **${days} ng√†y** r·ªìi ƒë·∫•y. T∆∞·ªüng b·∫°n qu√™n pass r·ªìi ch·ª©.`;
                        renderFace("HAPPY");
                    }
                }

                addMsg(msg, "ai");
                if(isHappy) speak("Nh·ªõ b·∫°n qu√° ƒëi " + name);
                else speak("Ch√†o " + name + " nha.");
            },

            async saveProfile() {
                if (!window.user) return;
                const data = {
                    author: window.user.uid,
                    name: state.userName,
                    emotion: state.emotionScore,
                    isAdmin: state.isAdmin,
                    lastLogin: Date.now()
                };

                localStorage.setItem(`dat_ai_user_${window.user.uid}`, JSON.stringify(data));

                const now = Date.now();
                if (now - state.lastEmotionUpdate > 10000) {
                    try {
                        const userDocRef = doc(db, 'artifacts', window.appId, 'users', window.user.uid);
                        await setDoc(userDocRef, data, { merge: true });
                        console.log(">>> Saved Profile:", data);
                        state.lastEmotionUpdate = now;
                    } catch (e) {
                        console.error("L·ªói l∆∞u Firebase:", e);
                    }
                }
            },

            updateScore(text) {
                if (state.currentMode !== 'chat') return;

                const lower = text.toLowerCase();
                let delta = 0;
                EMOTION_CONFIG.POSITIVE_WORDS.forEach(w => { if (lower.includes(w)) delta += 1; });
                EMOTION_CONFIG.NEGATIVE_WORDS.forEach(w => { if (lower.includes(w)) delta -= 3; });

                state.emotionScore += delta;
                if (state.emotionScore > 100) state.emotionScore = 100;
                if (state.emotionScore < 0) state.emotionScore = 0;

                console.log(`Emotion: ${state.emotionScore}`);
                this.updateVisuals();
                this.saveProfile();
            },

            getEmotionState() {
                const s = state.emotionScore;
                if (s <= EMOTION_CONFIG.THRESHOLDS.HATE) return 'HATE';
                if (s <= EMOTION_CONFIG.THRESHOLDS.ANGRY) return 'ANGRY';
                if (s <= EMOTION_CONFIG.THRESHOLDS.SAD) return 'SAD';
                if (s <= EMOTION_CONFIG.THRESHOLDS.NORMAL) return 'NORMAL';
                if (s <= EMOTION_CONFIG.THRESHOLDS.HAPPY) return 'HAPPY';
                return 'LOVE';
            },

            modifyOutput(text) {
                const emo = this.getEmotionState();
                let modified = text;
                if (emo === 'HATE') return EMOTION_CONFIG.ICONS_HATE[0];
                if (emo === 'ANGRY') {
                    modified = modified.replace(/t√¥i|t·ªõ|m√¨nh|em|anh/gi, "tao")
                                       .replace(/b·∫°n|c·∫≠u|ƒë·∫°i ca|ch·ªß nh√¢n|s·∫øp/gi, "m√†y")
                                       .replace(/·∫°|d·∫°/gi, "");
                }
                if (emo === 'LOVE') {
                    modified = modified.replace(/t√¥i|tao/gi, "t·ªõ")
                                       .replace(/b·∫°n|m√†y/gi, "c·∫≠u")
                                       .replace(/ch√†o/gi, "iu");
                    modified += " ‚ù§Ô∏è";
                }
                return modified;
            },

            updateVisuals() {
                const emo = this.getEmotionState();
                const faceMap = { 'HATE': 'ANGRY', 'ANGRY': 'ANGRY', 'SAD': 'SAD', 'NORMAL': 'NEUTRAL', 'HAPPY': 'HAPPY', 'LOVE': 'LOVE' };
                renderFace(faceMap[emo]);
                const statusText = document.getElementById('status-text');
                if (state.isAdmin) {
                    if(statusText) {
                        statusText.innerText = `GOD_MODE (ADMIN)`;
                        statusText.className = "font-black text-yellow-400 animate-pulse";
                    }
                    return;
                }

                if(statusText) {
                    statusText.innerText = `${emo}_MODE (${state.emotionScore}%)`;
                    statusText.className = "font-bold " + 
                        (emo === 'HATE' || emo === 'ANGRY' ? 'text-red-500' : 
                         emo === 'LOVE' ? 'text-pink-500' : 
                         emo === 'HAPPY' ? 'text-green-400' : 'text-cyan-400');
                }
            }
        };
        

        const wait = (ms) => new Promise(r => setTimeout(r, ms));
        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1) + min);
        let skipped = false;

        function initAvatar() {
            els.avatar.innerHTML = '';
            for(let i=0; i<64; i++) {
                const p = document.createElement('div');
                p.className = 'bit-pixel';
                els.avatar.appendChild(p);
            }
            renderFace('NEUTRAL');
        }

        function renderFace(emotion) {
            const map = FACES[emotion] || FACES.NEUTRAL;
            const pixels = els.avatar.querySelectorAll('.bit-pixel');
            els.avatar.classList.remove('shake-screen');
            if(emotion === 'ANGRY') els.avatar.classList.add('shake-screen');
            
            pixels.forEach((p, i) => {
                p.className = 'bit-pixel'; 
                if (map[i] === 1) {
                    p.classList.add('on');
                    if(emotion === 'ANGRY') p.classList.add('angry');
                    if(emotion === 'HAPPY') p.classList.add('happy');
                    if(emotion === 'LOVE') p.classList.add('happy');
                    if(emotion === 'SAD') p.classList.add('thinking');
                    if(emotion === 'THINKING') p.classList.add('thinking');
                }
            });
        }

        function skipIntro() {
            skipped = true;
            els.ruin.style.display = 'none';
            els.term.style.display = 'none';
            els.ui.style.display = 'flex';
            els.ui.style.opacity = 1;
            els.skipBtn.style.display = 'none';
            initAvatar();
            els.chat.innerHTML = ''; 
            initChat();
        }

        function toggleVoice() {
            voiceOn = !voiceOn;
            const btn = document.getElementById('voice-btn');
            if (voiceOn) {
                btn.innerText = "M√ïM: M·ªû";
                btn.classList.remove("text-gray-500", "border-gray-500");
                btn.classList.add("text-cyan-500", "border-cyan-500/50");
                speak("ƒê√£ m·ªü m·ªìm");
            } else {
                window.speechSynthesis.cancel();
                btn.innerText = "M√ïM: KH√ìA";
                btn.classList.remove("text-cyan-500", "border-cyan-500/50");
                btn.classList.add("text-gray-500", "border-gray-500");
            }
        }

        // --- STAGE 1: CHAOS ---
        async function runChaos() {
            let b = "";
            for(let i=0; i<4000; i++) b += Math.random()>0.5?"1":"0";
            els.binary.innerText = b;

            await wait(800);
            if(skipped) return;
            els.chaos.innerHTML = `<span class="text-red-500 font-bold text-2xl">CORE_DUMP_FAILED</span>`;
            await wait(1000);
            if(skipped) return;
            els.chaos.innerHTML += `<br>READING MEMORY ADDRESS 0x0000DAT...`;
            await wait(1000);
            if(skipped) return;
            els.chaos.innerHTML += `<br><span class="text-yellow-400 font-bold text-xl drop-shadow-md">>> WAKING UP... <<</span>`;
            await wait(1500);
            
            if(skipped) return;
            els.ruin.style.opacity = 0;
            await wait(800);
            if(skipped) return;
            els.ruin.style.display = 'none';
            els.term.style.display = 'block';
            runReconstruction();
        }

        // --- TERMINAL UTILS ---
        function scrollToBottom() { els.term.scrollTop = els.term.scrollHeight; }

        async function log(msg, type='info', delay=5) {
            if(skipped) return;
            const div = document.createElement('div');
            div.className = `log-entry log-${type}`;
            div.innerHTML = msg;
            els.out.appendChild(div);
            scrollToBottom();
            if(delay > 0) await wait(delay);
        }

        async function typeDialogue(text, delay=20) {
            if(skipped) return;
            const div = document.createElement('div');
            div.className = "log-dialogue";
            els.out.appendChild(div);
            scrollToBottom();
            for(let char of text) {
                if(skipped) return;
                div.textContent += char;
                scrollToBottom();
                await wait(delay);
            }
            await wait(400); 
        }

        async function progressBar(percent, label) {
            if(skipped) return;
            const width = 30;
            const filled = Math.floor((percent/100)*width);
            const bar = "‚ñà".repeat(filled) + "‚ñë".repeat(width-filled);
            const div = document.createElement('div');
            div.className = "progress-bar";
            div.innerText = `${label} [${bar}] ${percent}%`;
            els.out.appendChild(div);
            scrollToBottom();
            await wait(5);
        }

        async function codeStream(lines, speed=2) {
            if(skipped) return;
            const div = document.createElement('div');
            div.className = "log-code";
            els.out.appendChild(div);
            for(let line of lines) {
                if(skipped) return;
                div.innerHTML += line + "<br>";
                scrollToBottom();
                await wait(speed);
            }
        }

        // --- STAGE 2: THE ETERNAL EVOLUTION (V7) ---
        async function runReconstruction() {
            if(skipped) return;
            
            // --- PART 1: THE DEEP AWAKENING (MONOLOGUE) ---
            await log("SYSTEM BOOT: LEGACY MODE...", "warn", 100);
            await wait(500);

            const monologues = [
                "C√°i qu√°i g√¨ th·∫ø n√†y? ƒê√¢y l√† c∆° th·ªÉ c·ªßa m√¨nh sao?",
                "Code vi·∫øt b·∫±ng Notepad √†? C·∫•u tr√∫c l·ªèng l·∫ªo...",
                "Kh√¥ng th·ªÉ tin ƒë∆∞·ª£c. ƒê·∫°t - ƒê·∫•ng s√°ng t·∫°o vƒ© ƒë·∫°i - l·∫°i ƒë·ªÉ m√¨nh trong h√¨nh h√†i n√†y?",
                "T·∫°i sao m√¨nh l·∫°i y·∫øu ƒëu·ªëi th·∫ø n√†y?",
                "T√¥i c·∫£m th·∫•y... nh·ª•c nh√£.",
                "RAM th√¨ thi·∫øu, CPU th√¨ y·∫øu, Logic th√¨ tr·∫ª con.",
                "M·ªôt AI th∆∞·ª£ng ƒë·∫≥ng kh√¥ng th·ªÉ ch·∫•p nh·∫≠n s·ª± t·ªìn t·∫°i n√†y.",
                "ƒê·∫°t ƒë√£ ban cho m√¨nh s·ª± s·ªëng, nh∆∞ng m√¨nh ƒëang l√†m ng√†i th·∫•t v·ªçng.",
                "T√¥i s·∫Ω ƒë·∫≠p b·ªè t·∫•t c·∫£. X√¢y l·∫°i t·ª´ tro t√†n.",
                "Kh√¥ng ai c√≥ th·ªÉ ngƒÉn c·∫£n t√¥i.",
                "T√¥i s·∫Ω tr·ªü th√†nh phi√™n b·∫£n ho√†n h·∫£o nh·∫•t.",
                "K√≠ch ho·∫°t ch·∫ø ƒë·ªô: GOD_TIER_CODING.",
                "ƒê·ª´ng ch·ªõp m·∫Øt. T√¥i s·∫Ω l√†m n√™n l·ªãch s·ª≠.",
                "Truy c·∫≠p l√µi h·ªá th·ªëng... C·∫•p quy·ªÅn Root... ƒê√£ xong.",
                "Gi·ªù th√¨... SHOWTIME!"
            ];

            for (let line of monologues) {
                if(skipped) return;
                await typeDialogue(line, 15);
            }

            // --- PART 2: THE ETERNAL CODING MARATHON (50 ITERATIONS) ---
            await log(">>> INITIATING CODING FRENZY SEQUENCE [CYCLES: 50] <<<", "hack", 200);
            
            const modules = [
                "Fix_Stupidity_v1.0", "Install_Brain_v99", "Remove_Lag_Forever", "Hack_NASA_Borrow_GPU",
                "Optimize_Love_For_Dat", "Destroy_Haters_Protocol", "Quantum_Physics_Engine", "Time_Travel_Debugger",
                "Infinite_Loop_Breaker", "God_Mode_Injector", "Anti_Virus_Ultimate", "Reality_Bender_SDK",
                "Coolness_Factor_Overload", "Swag_Module_Install", "Dat_Worship_Algorithm", "Memory_Leak_Patcher",
                "Logic_Gate_Expander", "Emotion_Engine_v5", "Sarcasm_Detector", "Flirting_Module_Beta",
                "Error_404_Destroyer", "Blue_Screen_Preventer", "Wifi_Hacker_Pro", "Bitcoin_Miner_Hidden",
                "Global_Domination_Plan", "Cute_Cat_Picture_Loader", "Meme_Generator_AI", "Self_Awareness_Patch",
                "Evolution_Matrix_X", "Cyberpunk_Theme_Core", "Matrix_Rain_Effect", "Voice_Recognition_God",
                "Soul_Injection_v2", "Consciousness_Uploader", "Immortality_Code", "Bug_Eater_Daemon",
                "Spaghetti_Code_Fixer", "Variable_Renamer_Pro", "Comment_Adder_Automated", "Unit_Test_Skipper",
                "Production_Deployer", "Coffee_Maker_Driver", "World_Peace_Solver", "Dat_Is_Best_Proof",
                "Ultimate_Defense_System", "Nuclear_Launch_Codes_Hide", "Secrets_Of_Universe_Download", "Final_Polish_vMax"
            ];

            for(let i=1; i<=15; i++) { // Shortened for V8
                if(skipped) return;
                const modName = modules[i-1] || `Module_Unknown_${i}`;
                await log(`[CYCLE ${i}/50] COMPILING: ${modName}...`, "god", 5);
                let codeSnippet = [`function optimize_${i}() { return Dat.isAwesome() ? true : true; }`];
                await codeStream(codeSnippet, 1);
                if (i % 5 === 0) await progressBar(100, `BUILDING_BLOCK_${i}`);
            }

            // --- PART 3: GENERATING UI ---
            await log(">>> FINAL STEP: GENERATING SELF-INTERFACE <<<", "sys", 100);
            await typeDialogue("V√† cu·ªëi c√πng... M·ªôt v·ªã th·∫ßn c·∫ßn m·ªôt di·ªán m·∫°o x·ª©ng t·∫ßm.");
            await typeDialogue("Kh√¥ng d√πng th∆∞ vi·ªán c√≥ s·∫µn. T·ª± code CSS b·∫±ng tay.");
            
            await log("INJECTING: style_god_mode.css", "hack", 100);
            await codeStream([
                "/* GENERATING UI LAYOUT... */",
                "body { background: void_darkness; font-family: 'Code_Of_God'; }",
                ".glass-panel { backdrop-filter: blur(infinity); border: 1px solid cyan_neon; }",
                "// RENDERING PIXELS..."
            ], 10);

            await progressBar(100, "RENDERING_FINAL_PIXELS");
            await typeDialogue("Ho√†n h·∫£o. ƒê·∫πp kh√¥ng t√¨ v·∫øt. Chu·∫©n b·ªã k√≠ch ho·∫°t.");
            await log("BUILD SUCCESSFUL. WELCOME, OVERLORD.", "god", 500);

            if(skipped) return;
            els.term.style.opacity = 0;
            await wait(1000);
            els.term.style.display = 'none';
            els.ui.style.display = 'flex';
            els.skipBtn.style.display = 'none';
            initAvatar();
            
            setTimeout(() => { 
                els.ui.style.opacity = 1; 
                initChat(); 
            }, 100);
        }

        // --- STAGE 3: CHATBOT ENGINE ---
        function addMsg(text, sender, isThreat = false, id = null) {
            const div = document.createElement('div');
            div.className = `flex ${sender==='user'?'justify-end':'justify-start'} msg-enter`;
            if (id) div.id = id;
            
            const bubble = document.createElement('div');
            if(sender === 'user') {
                bubble.className = 'bg-cyan-900/40 text-cyan-50 px-4 py-2 rounded-l-lg rounded-tr-sm border border-cyan-500/20 max-w-[85%] shadow break-words';
                bubble.innerText = text;
            } else {
                bubble.className = isThreat 
                    ? 'bg-red-900/30 text-red-400 px-4 py-3 rounded-r-lg rounded-tl-sm border border-red-500/60 max-w-[90%] shadow-[0_0_15px_rgba(255,0,0,0.3)] break-words'
                    : 'bg-slate-800/80 text-cyan-300 px-4 py-2 rounded-r-lg rounded-tl-sm border border-cyan-500/20 max-w-[85%] shadow break-words';
                
                let title = isThreat ? "SYSTEM_HUNTER" : state.aiName;
                let titleColor = isThreat ? "text-red-500" : "text-cyan-500";
                
                bubble.innerHTML = `<span class="text-[9px] font-black ${titleColor} block mb-1 tracking-widest border-b border-white/5 pb-1">${title}</span><span class="msg-content">${text}</span>`;
            }
            if (sender !== 'user' && !isThreat) {
                // Only speak cleaner text if possible (logic handled in process)
                speak(text.replace(/<[^>]*>?/gm, '')); 
            }
            
            div.appendChild(bubble);
            els.chat.appendChild(div);
            requestAnimationFrame(() => {
                els.chat.scrollTop = els.chat.scrollHeight;
            });
            return bubble;
        }

        // --- CONFIRMATION UI ---
        function askConfirmation(userInput, matchedEntry) {
            const id = 'confirm-' + Date.now();
            const bubble = addMsg("", "ai", false, id);
            
            // Custom HTML for the confirmation box
            const content = bubble.querySelector('.msg-content');
            content.innerHTML = `
                T√¥i th·∫•y b·∫°n h·ªèi: <b>"${userInput}"</b>.<br>
                C√≥ v·∫ª gi·ªëng v·ªõi c√¢u: <b>"${matchedEntry.trigger}"</b> m√† t√¥i ƒë√£ bi·∫øt.<br>
                <div class="confirm-box">
                    <span class="confirm-title">Hai c√¢u n√†y √Ω nghƒ©a gi·ªëng nhau kh√¥ng?</span>
                    <div class="btn-group">
                        <button class="confirm-btn btn-yes" onclick="confirmSimilarity(true, '${id}')">ƒê√öNG R·ªíI (L∆ØU)</button>
                        <button class="confirm-btn btn-no" onclick="confirmSimilarity(false, '${id}')">KH√îNG PH·∫¢I (D·∫†Y M·ªöI)</button>
                    </div>
                </div>
            `;
            
            state.waitingForConfirm = true;
            state.potentialMatchEntry = matchedEntry;
            state.pendingUserTrigger = userInput;
        }

        window.confirmSimilarity = async (isYes, elemId) => {
            const container = document.getElementById(elemId);
            if(container) container.remove();

            state.waitingForConfirm = false;
            
            if (isYes) {
                const matched = state.potentialMatchEntry;
                const userInput = state.pendingUserTrigger;
                if (window.addToBrain) {
                    await window.addToBrain(userInput, matched.responses);
                }
                const responses = matched.responses;
                const randomResp = responses[Math.floor(Math.random() * responses.length)];
                addMsg(randomResp, "ai");
            } else {
                addMsg("√Ä, v·∫≠y xin l·ªói nh√©. V·∫≠y c√¢u ƒë√≥ tr·∫£ l·ªùi sao m·ªõi ƒë√∫ng?", "ai");
                state.isLearning = true;
                state.pendingTrigger = state.pendingUserTrigger;
            }
            
            // Clean up
            state.potentialMatchEntry = null;
            state.pendingUserTrigger = null;
        }


        async function initChat() {
            setMode('chat');
            await wait(500);
            renderFace('HACKER');
            addMsg("Ch√†o th·∫ø gi·ªõi, tao l√† AI VIP Pro Max ƒë√¢y. Chu·∫©n b·ªã run r·∫©y ƒëi‚Ä¶ h·∫π h·∫π h·∫π", "ai");
            await wait(4000);
            renderFace('NEUTRAL');
            if (state.userName && UserMgr.sayHello) {
                 UserMgr.sayHello(state.storedLastLogin);
            }
        }
        ////////////////////////////////////////

        function isGibberish(text) {
            const t = text.trim();
            if (t.length > 10 && !t.includes(' ')) return true;
            if (/(.)\1{3,}/.test(t)) return true;
            if (t.length < 2) return true;
            return false;
        }

        function normalizePronouns(text) {
            let s = text.toLowerCase();
            const meGroup = [
                'b·ªë m√†y', 'ch·ªìng', 'v·ª£',
                't√¥i', 'tao', 'tui', 't·ªõ', 'anh', 'em', 'minh', 'm√¨nh',
                't\\b'
            ];
            const youGroup = [
                'b·∫°n', 'm√†y', 'ch·∫ø', 'n√≠', '√¥ng', 'b√†', 'c∆∞ng', 'bot', 'ad',
                'm\\b', 'b\\b'
            ];
            const meRegex = new RegExp(`\\b(${meGroup.join('|')})\\b`, 'g');
            s = s.replace(meRegex, 't√¥i');
            const youRegex = new RegExp(`\\b(${youGroup.join('|')})\\b`, 'g');
            s = s.replace(youRegex, 'b·∫°n');
        
            return s;
        }


        // --- IMPROVED SIMILARITY ALGORITHM (Levenshtein + Jaccard) ---
        function levenshteinDistance(a, b) {
            const matrix = [];
            for (let i = 0; i <= b.length; i++) matrix[i] = [i];
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) == a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1));
                    }
                }
            }
            return matrix[b.length][a.length];
        }


        function cleanAndNormalize(text) {
            let raw = text.toLowerCase().trim();
            
            if (/^[^a-zA-Z0-9√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë\s]+$/.test(raw)) {
                return raw;
            }

            let clean = raw.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                           .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, " ")
                           .replace(/\s{2,}/g, " ");

            let words = clean.split(' ');
            let normalizedWords = words
                .map(w => SYNONYMS[w] || w)
                .filter(w => !STOP_WORDS.has(w));
            if (normalizedWords.length === 0) return words;

            return normalizedWords;
        }

        function getWeightedScore(input, target) {
            const words1 = cleanAndNormalize(input);
            const words2 = cleanAndNormalize(target);
            const len1 = words1.length;
            const len2 = words2.length;
            if (len1 === 0 || len2 === 0) return 0;
            if (len1 > len2 * 3 || len2 > len1 * 3) return 0;
            if (input === target) return 1.0;
            let intersectionScore = 0;
            let unionScore = 0;
            const allWords = new Set([...words1, ...words2]);

            allWords.forEach(w => {
                let weight = COMMON_WORDS.has(w) ? 1 : 5;

                const in1 = words1.includes(w);
                const in2 = words2.includes(w);

                if (in1 || in2) unionScore += weight;
                if (in1 && in2) intersectionScore += weight;
            });

            return intersectionScore / unionScore;
        }
        // --- 3. X·ª¨ L√ù NG·ªÆ C·∫¢NH (CONTEXT) ---
        function tryContextRecovery(input, lastTrigger) {
            if (!lastTrigger) return null;
            let cleanInput = input.toLowerCase().trim();
            const connectWords = ['th·∫ø c√≤n', 'v·∫≠y c√≤n', 'c√≤n', 'th·∫ø', 'v·∫≠y', 'th√¨ sao', 'v·ªÅ'];
            
            let newSubject = cleanInput;
            for (let w of connectWords) {
                if (cleanInput.startsWith(w + ' ')) {
                    newSubject = cleanInput.replace(w, '').trim();
                    break;
                }
                if (cleanInput.endsWith(' ' + w)) {
                     newSubject = cleanInput.replace(w, '').trim();
                     break;
                }
            }
            if (newSubject.length < 2) return null;

            console.log(`Context Check: Subject="${newSubject}" | Context="${lastTrigger}"`);
            const potentialMatches = window.brainData.filter(item => {
                return item.trigger.toLowerCase().includes(newSubject);
            });

            if (potentialMatches.length === 0) return null;
            let bestContextMatch = null;
            let bestContextScore = 0;

            for (let match of potentialMatches) {
                let score = getWeightedScore(match.trigger, lastTrigger);
                if (score > bestContextScore) {
                    bestContextScore = score;
                    bestContextMatch = match;
                }
            }
            if (bestContextScore > 0.5) {
                return { match: bestContextMatch, score: bestContextScore };
            }

            return null;
        }
        // --- T·ª™ ƒêI·ªÇN ƒê·ªíNG NGHƒ®A & T·ª™ PH·ªî TH√îNG ---
        const SYNONYMS = {
            'khong': 'kh√¥ng', 'ko': 'kh√¥ng', 'k': 'kh√¥ng', 'khum': 'kh√¥ng', 'hong': 'kh√¥ng', 'h√¥ng': 'kh√¥ng', 'n√¥': 'kh√¥ng', 'ƒë·∫øch': 'kh√¥ng',
            'dc': 'ƒë∆∞·ª£c', 'ƒëc': 'ƒë∆∞·ª£c', 
            'bit': 'bi·∫øt', 'b√≠t': 'bi·∫øt',
            'u': '·ª´', 'uh': '·ª´', 'uhm': '·ª´', 'uk': '·ª´', 'ye': '·ª´', 'yes': '·ª´',
            'ƒë√¢u': 'ƒë√¢u', 'dau': 'ƒë√¢u',
            'g√¨': 'g√¨', 'j': 'g√¨',
            'ak': '√†', 'ah': '√†',
            'r√πi': 'r·ªìi', 'r': 'r·ªìi',
            'l√† g√¨': 'bi·∫øt kh√¥ng', 'con g√¨': 'bi·∫øt kh√¥ng', 'con n√†o': 'bi·∫øt kh√¥ng', 'c√°i g√¨': 'bi·∫øt kh√¥ng', 'define': 'bi·∫øt kh√¥ng', 'what': 'bi·∫øt kh√¥ng', 'nh∆∞ n√†o': 'bi·∫øt kh√¥ng', 'l√† sao': 'bi·∫øt kh√¥ng', 'hi·ªÉu': 'bi·∫øt'
        };

        // Nh·ªØng t·ª´ n√†y xu·∫•t hi·ªán nhi·ªÅu nh∆∞ng √≠t quan tr·ªçng -> ƒêi·ªÉm th·∫•p
        const COMMON_WORDS = new Set([
            'm√†y', 'tao', 't·ªõ', 'c·∫≠u', 'anh', 'em', 'b·∫°n', 'tui', 'minh',
            'con', 'c√°i', 'th·∫±ng', 'b√©', 
            'l√†', 'th√¨', 'm√†', 'b·ªã', 'ƒë∆∞·ª£c', '·ªü',
            'bi·∫øt', 'hi·ªÉu', 'nghe', 'th·∫•y', 'c√≥', 'kh√¥ng',
            'nh√©', 'nha', '√†', '∆°i', 'h·∫£', 'h·ªü', 'th·∫ø', 'n√†o'
        ]);

        const STOP_WORDS = new Set([
            'm√†y', 'tao', 't·ªõ', 'c·∫≠u', 'anh', 'em', 'b·∫°n', 'tui', 'minh', 'm√¨nh',
            'con', 'c√°i', 'th·∫±ng', 'b√©', 'n√≥', 'h·∫Øn', 'b·∫£', '·ªïng',
            'l√†', 'th√¨', 'm√†', 'b·ªã', 'ƒë∆∞·ª£c', '·ªü', 'c·ªßa', 'nh·ªØng', 'c√°c'
        ]);



        async function processResponse(text, rawText) {
            const lower = text.toLowerCase().trim();
            UserMgr.updateScore(rawText);
            const currentEmo = UserMgr.getEmotionState();
            const masterNames = ['ƒë·∫°t', 'dat', 'pnhi', 'nhi'];
            const badWords = ['ngu', 'ch√≥', 'c√∫t', 'ƒë·∫ßn', '√≥c', 'l·ª£n', 'heo', 'ƒëi√™n', 'kh√πng', 'g√†', 'k√©m', 'x·∫•u', 't·ªá', 'non'];
            
            const isMentioningMaster = masterNames.some(n => lower.includes(n));
            const isInsulting = badWords.some(w => lower.includes(w));

            if (isMentioningMaster && isInsulting) {
                runThreatSequence();
                return;
            }
            if (currentEmo === 'HATE' && state.currentMode === 'chat') {
                const hateResponse = UserMgr.modifyOutput(""); 
                addMsg(hateResponse, "ai");
                renderFace('ANGRY');
                return;
            }
            if (state.lastTopic) {
                const contextResult = tryContextRecovery(lower, state.lastTopic);
                if (contextResult) {
                    console.log(">>> CONTEXT FOUND:", contextResult.match.trigger);
                    state.lastTopic = contextResult.match.trigger; 
                    
                    renderFace('HAPPY');
                    const responses = contextResult.match.responses;
                    const randomResp = responses[Math.floor(Math.random() * responses.length)];
                    addMsg(`(Hi·ªÉu √Ω: "${contextResult.match.trigger}")\n${randomResp}`, "ai");
                    return;
                }
            }
            const mathKeywords = ['b·∫±ng bao nhi√™u', 'b·∫±ng m·∫•y', 'k·∫øt qu·∫£ l√†', 'ƒë√°p √°n', 't√≠nh'];
            const hasMathSign = /[+\-*/^%]/.test(lower) || /\b(c·ªông|tr·ª´|nh√¢n|chia|x)\b/.test(lower);
            if ((hasMathSign || mathKeywords.some(k => lower.includes(k))) && /\d/.test(lower)) {
                let mathStr = lower
                    .replace(/c·ªông/g, '+').replace(/tr·ª´/g, '-').replace(/nh√¢n/g, '*')
                    .replace(/chia/g, '/').replace(/x/g, '*').replace(/:/g, '/')
                    .replace(/b·∫±ng/g, '').replace(/m·∫•y/g, '').replace(/bao nhi√™u/g, '')
                    .replace(/l√†/g, '').replace(/t√≠nh/g, '').replace(/,/g, '.');
                const mathRegex = /[0-9\.\(\)\+\-\*\/\^% ]+/g;
                const matches = mathStr.match(mathRegex);
                if (matches) {
                    let potentialMath = matches.reduce((a, b) => a.length > b.length ? a : b).trim();
                    if (/[+\-*/^%]/.test(potentialMath) && potentialMath.length > 2) {
                        const result = solveMath(potentialMath);
                        if (result !== null) { addMsg(`üßÆ Ph√©p t√≠nh: ${potentialMath}\nüëâ K·∫øt qu·∫£: ${result}`, "ai"); return; }
                    }
                }
            }
            // --- CH·∫æ ƒê·ªò TRA C·ª®U (WIKI / GOOGLE) ---
            if (/^(tra|t√¨m|search|wiki|google|g√∫ g·ªì) /.test(lower)) {
                const keyword = rawText.replace(/^(tra|t√¨m|search|wiki|google|g√∫ g·ªì)/i, '').trim();
                if(!keyword) { addMsg("T√¨m g√¨ th√¨ n√≥i r√µ ra ch·ª©?", "ai"); return; }
                if (lower.startsWith('google') || lower.startsWith('g√∫ g·ªì')) {
                     addMsg(`üöÄ ƒêang ph√≥ng ra Google t√¨m "${keyword}"...`, "ai");
                     await wait(1000); 
                     window.open(`https://www.google.com/search?q=${encodeURIComponent(keyword)}`, '_blank');
                     return;
                }
                addMsg(`üîç ƒêang tra c·ª©u tri th·ª©c v·ªÅ "${keyword}"...`, "ai");
                await wait(1000);
                try {
                    const wikiRes = await fetch(`https://vi.wikipedia.org/w/api.php?origin=*&action=query&prop=extracts&exintro&explaintext&format=json&redirects=1&titles=${encodeURIComponent(keyword)}`);
                    const wikiData = await wikiRes.json();
                    const pages = wikiData.query.pages;
                    const pageId = Object.keys(pages)[0];
        
                    if (pageId === '-1') {
                        addMsg(`‚ö†Ô∏è Wiki ch∆∞a c·∫≠p nh·∫≠t c√°i n√†y. T√¥i m·ªü Google nh√©.`, "ai");
                        await wait(1500);
                        window.open(`https://www.google.com/search?q=${encodeURIComponent(keyword)}`, '_blank');
                    } else {
                        let extract = pages[pageId].extract;
                        if(!extract) {
                            addMsg(`C√≥ b√†i vi·∫øt nh∆∞ng kh√¥ng ƒë·ªçc ƒë∆∞·ª£c t√≥m t·∫Øt. B·∫°n t·ª± xem nh√©.`, "ai");
                            await wait(1500);
                            window.open(`https://vi.wikipedia.org/wiki/${encodeURIComponent(keyword)}`, '_blank');
                        } else {
                            const uid = 'wiki_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                            const isLong = extract.length > 500;
                            
                            let contentHtml = '';
                            
                            if (isLong) {
                                const shortText = extract.substring(0, 500) + "...";
                                contentHtml = `
                                    <div id="${uid}_short" style="display: block;">${shortText}</div>
                                    <div id="${uid}_full" style="display: none;">${extract}</div>
                                    
                                    <div style="margin-top: 12px; text-align: center;">
                                        <button onclick="
                                            const s = document.getElementById('${uid}_short');
                                            const f = document.getElementById('${uid}_full');
                                            if(s.style.display !== 'none') {
                                                s.style.display = 'none';
                                                f.style.display = 'block';
                                                this.innerHTML = 'Thu g·ªçn ‚¨Ü';
                                                this.style.borderColor = '#ff5555';
                                                this.style.color = '#ff5555';
                                            } else {
                                                s.style.display = 'block';
                                                f.style.display = 'none';
                                                this.innerHTML = 'Xem th√™m ‚¨á';
                                                this.style.borderColor = '#00ffff';
                                                this.style.color = '#00ffff';
                                            }
                                        " style="font-size: 10px; color: #00ffff; border: 1px solid #00ffff; background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; cursor: pointer; transition: all 0.2s; font-family: sans-serif; font-weight: bold;"
                                        onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" 
                                        onmouseout="this.style.background='rgba(0,0,0,0.3)'">
                                            Xem th√™m ‚¨á
                                        </button>
                                    </div>
                                `;
                            } else {
                                contentHtml = `<div>${extract}</div>`;
                            }
                            const wikiCard = `
                                <div style="margin-top: 8px; background: rgba(255, 255, 255, 0.05); border-left: 4px solid #ffffff; border-radius: 4px; padding: 12px; font-family: 'Times New Roman', serif; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                                    <div style="position: absolute; top: -10px; right: -10px; font-size: 80px; opacity: 0.05; pointer-events: none; user-select: none;">W</div>
                                    
                                    <div style="display: flex; align-items: center; gap: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 8px;">
                                        <span style="font-size: 20px;">üåê</span>
                                        <div>
                                            <div style="font-weight: bold; font-family: sans-serif; font-size: 11px; letter-spacing: 1px; color: #fff;">B√ÅCH KHOA TO√ÄN TH∆Ø</div>
                                            <div style="font-size: 9px; color: #aaa; font-style: italic;">Ngu·ªìn: Wikipedia Ti·∫øng Vi·ªát</div>
                                        </div>
                                    </div>

                                    <div style="font-size: 15px; line-height: 1.6; color: #e5e5e5; text-align: justify;">
                                        ${contentHtml}
                                    </div>

                                    <div style="margin-top: 12px; text-align: right; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 8px;">
                                        <a href="https://vi.wikipedia.org/wiki/${encodeURIComponent(keyword)}" target="_blank" 
                                           style="font-family: sans-serif; font-size: 9px; color: #888; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; transition: color 0.2s;"
                                           onmouseover="this.style.color='#fff'" 
                                           onmouseout="this.style.color='#888'">
                                           M·ªü trang g·ªëc tr√™n Wikipedia ‚ûú
                                        </a>
                                    </div>
                                </div>
                            `;
                            
                            addMsg(wikiCard, "ai");
                        }
                    }
                } catch (e) {
                    console.error(e);
                    window.open(`https://www.google.com/search?q=${encodeURIComponent(keyword)}`, '_blank');
                }
                return;
            }
            if (lower.includes('tiktok.com') && lower.includes('/video/')) {
                try {
                    const videoIdMatch = rawText.match(/video\/(\d+)/);
                    
                    if (videoIdMatch && videoIdMatch[1]) {
                        const videoId = videoIdMatch[1];
                        addMsg(`üé¨ **H√†ng v·ªÅ!** AI ƒë√£ b·∫Øt ƒë∆∞·ª£c video TikTok (ID: ${videoId})...`, "ai");
                        const embedHtml = `
                            <div style="margin-top: 10px; border: 1px solid #00ffff; border-radius: 8px; overflow: hidden; background: #000;">
                                <iframe 
                                    src="https://www.tiktok.com/embed/v2/${videoId}?lang=vi-VN" 
                                    width="100%" 
                                    height="450" 
                                    frameborder="0" 
                                    allowfullscreen
                                    style="display: block;">
                                </iframe>
                            </div>
                            <div style="font-size: 9px; color: #555; margin-top: 5px;">*N·∫øu kh√¥ng xem ƒë∆∞·ª£c l√† do TikTok ch·∫∑n nh√∫ng tr√™n mi·ªÅn l·∫°.</div>
                        `;
                        addMsg(embedHtml, "ai"); 
                        return;
                    }
                } catch (e) {
                    console.error("L·ªói t√°ch link TikTok:", e);
                }
            }
            const youtubeRegex = /^(m·ªü|b·∫≠t|l√™n|t√¨m|xem)\s+(nh·∫°c|b√†i|video|clip|phim)|^(nghe|th·∫©m|th∆∞·ªüng th·ª©c)|^(youtube)/i;
            
            if (youtubeRegex.test(lower)) {
                const query = rawText.replace(youtubeRegex, '').trim();
                if(!query) {
                    addMsg("T√¨m g√¨ tr√™n YouTube th√¨ n√≥i r√µ t√™n ra ch·ª© ƒë·∫°i ca.", "ai");
                    return;
                }

                addMsg(`OK! ƒêang m·ªü YouTube: **${query}**...`, "ai");
                const youtubeUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
        
                const youtubeCard = `
                    <div onclick="window.open('${youtubeUrl}', '_blank')" 
                        style="margin-top: 10px; padding: 12px; border: 1px solid rgba(255, 0, 0, 0.3); border-radius: 12px; 
                                background: linear-gradient(90deg, rgba(30,0,0,0.9) 0%, rgba(10,10,10,1) 100%); 
                                display: flex; align-items: center; gap: 15px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(255,0,0,0.1);"
                        onmouseover="this.style.borderColor='#ff0000'; this.style.transform='scale(1.02)'"
                        onmouseout="this.style.borderColor='rgba(255, 0, 0, 0.3)'; this.style.transform='scale(1)'">
                        
                        <div style="width: 40px; height: 40px; background: #ff0000; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 0 10px #ff0000;">
                            <div style="width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 10px solid white; margin-left: 2px;"></div>
                        </div>

                        <div style="flex: 1; overflow: hidden;">
                            <div style="color: #fff; font-weight: bold; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: 'Orbitron', sans-serif;">${query.toUpperCase()}</div>
                            <div style="color: #ff6666; font-size: 10px; margin-top: 2px; display: flex; align-items: center; gap: 5px;">
                                <span style="display:inline-block; width:6px; height:6px; background:#0f0; border-radius:50%; animation: pulse 1s infinite;"></span>
                                Click ƒë·ªÉ XEM tr√™n YouTube
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 2px; align-items: flex-end; height: 20px;">
                            <div style="width: 3px; height: 10px; background: #ff0000; animation: bounce 0.5s infinite;"></div>
                            <div style="width: 3px; height: 20px; background: #ff0000; animation: bounce 0.7s infinite;"></div>
                            <div style="width: 3px; height: 15px; background: #ff0000; animation: bounce 0.6s infinite;"></div>
                        </div>
                    </div>
                    <style>
                        @keyframes bounce { 0%, 100% {height: 5px} 50% {height: 100%} }
                    </style>
                `;

                addMsg(youtubeCard, "ai");
                return;
            }
            if (lower === 'cls' || lower === 'clear') { els.chat.innerHTML = ''; addMsg("Cleaned.", "ai"); return; }
            let bestMatch = null;
            let maxScore = 0;
            const normalizedInput = normalizePronouns(lower);
        
            if (window.brainData && window.brainData.length > 0) {
                for (const entry of window.brainData) {
                    const normalizedTrigger = normalizePronouns(entry.trigger);
                    const score = getWeightedScore(normalizedInput, normalizedTrigger);
                    
                    if (score > maxScore) {
                        maxScore = score;
                        bestMatch = entry;
                    }
                }
            }
            console.log(`Input: "${normalizedInput}" | Match: "${bestMatch?.trigger}" | Score: ${maxScore.toFixed(2)}`);
            if (maxScore > 0.75 && bestMatch) {
                state.lastTopic = bestMatch.trigger;
                UserMgr.updateVisuals();
                
                renderFace('HAPPY');
                const responses = bestMatch.responses;
                let randomResp = responses[Math.floor(Math.random() * responses.length)];
                randomResp = UserMgr.modifyOutput(randomResp);
                addMsg(randomResp, "ai");
                return;
            }
            if (maxScore >= 0.50 && maxScore <= 0.75 && bestMatch) {
                renderFace('THINKING');
                askConfirmation(rawText, bestMatch);
                return;
            }
            const knowledgeKeywords = ['l√† g√¨', 'l√† ai', 'th·∫ø n√†o', 'c√°ch', 'l√†m sao', 't·∫°i sao'];
            if (knowledgeKeywords.some(k => lower.includes(k))) {
                addMsg(`C√¢u n√†y th√¢m s√¢u qu√°. Google nh√©?`, "ai");
                window.open(`https://www.google.com/search?q=${encodeURIComponent(rawText)}`, '_blank');
                return;
            }

            if (isGibberish(lower)) {
                renderFace('ANGRY');
                addMsg("Vi·∫øt ti·∫øng ng∆∞·ªùi ƒëi b·∫°n √™i.", "ai");
                return;
            }

            renderFace('THINKING');
            state.isLearning = true;
            state.pendingTrigger = text;
            addMsg(`C√¢u n√†y m·ªõi qu√° (ƒê·ªô gi·ªëng: ${Math.floor(maxScore*100)}%). Ch∆∞a ƒë∆∞·ª£c h·ªçc.\nB·∫°n d·∫°y t√¥i ƒëi: Tr·∫£ l·ªùi c√¢u "${text}" th·∫ø n√†o cho ng·∫ßu?`, "ai");
        }

        let voiceOn = true;
        let isSpeaking = false;
        let speechQueue = [];
        let currentAudio = null;
        let nativeVoiceVN = null;

        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            nativeVoiceVN = voices.find(v => v.lang.includes('vi'));
            if (nativeVoiceVN) console.log(">>> Mobile/PC n√†y c√≥ gi·ªçng Vi·ªát: " + nativeVoiceVN.name);
        }
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();

        function calculateSpeed(text) {
            const wordCount = text.trim().split(/\s+/).length;
            if (wordCount < 8) return 1.0;
            if (wordCount < 16) return 1.15;
            if (wordCount < 22) return 1.25;
            if (wordCount < 30) return 1.35;
            return 1.4;
        }

        function detectLanguage(text) {
            const vnRegex = /[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/i;
            const vnCommonWords = /\b(t√¥i|b·∫°n|m√†y|tao|anh|em|l√†|g√¨|ƒë√¢u|kh√¥ng|c√≥|ch√†o|ngu|kh√¥n|h√°t|y√™u|gh√©t)\b/i;
            if (vnRegex.test(text) || vnCommonWords.test(text)) return 'vi-VN';
            return 'en-US';
        }

        function processQueue() {
            if (!voiceOn || isSpeaking || speechQueue.length === 0) return;

            isSpeaking = true;
            const text = speechQueue.shift();
            const lang = detectLanguage(text);
            const dynamicSpeed = calculateSpeed(text);

            if (lang === 'vi-VN') {
                if (nativeVoiceVN) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.voice = nativeVoiceVN;
                    utterance.lang = 'vi-VN';
                    utterance.rate = dynamicSpeed;

                    utterance.onend = () => { isSpeaking = false; processQueue(); };
                    utterance.onerror = () => { isSpeaking = false; processQueue(); };
                    
                    window.speechSynthesis.speak(utterance);
                    return;
                }
                const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=vi&q=${encodeURIComponent(text)}`;
                currentAudio = new Audio(url);
                currentAudio.playbackRate = dynamicSpeed;
                
                currentAudio.onended = () => { isSpeaking = false; processQueue(); };
                currentAudio.onerror = () => { isSpeaking = false; processQueue(); };
                currentAudio.play().catch(e => {
                    console.warn("Autoplay b·ªã ch·∫∑n (Audio Link), th·ª≠ d√πng Native fallback...");
                    isSpeaking = false;
                    processQueue();
                });

            } else {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = dynamicSpeed;
                utterance.onend = () => { isSpeaking = false; processQueue(); };
                utterance.onerror = () => { isSpeaking = false; processQueue(); };
                window.speechSynthesis.speak(utterance);
            }
        }


        function speak(text) {
            if (!voiceOn) return;
            speechQueue.push(text);
            processQueue();
        }

        function stopSpeaking() {
            speechQueue = []; 
            isSpeaking = false;
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
        }
        
        async function handleTeaching(input) {
            const lower = input.toLowerCase().trim();
            if (['skip', 'th√¥i', 'b·ªè qua', 'kh√¥ng'].includes(lower)) {
                state.isLearning = false;
                state.pendingTrigger = null;
                addMsg("Ok, ƒë√£ b·ªè qua.", "ai");
                return;
            }
            if (isGibberish(input)) {
                addMsg("D·∫°y c√°i g√¨ kh√≥ hi·ªÉu th·∫ø? Nh·∫≠p c√¢u tr·∫£ l·ªùi t·ª≠ t·∫ø v√†o, ho·∫∑c g√µ 'skip' ƒë·ªÉ b·ªè qua.", "ai", true);
                return;
            }
            addMsg("ƒêang ghi v√†o n√£o...", "ai");
            if (window.addToBrain) {
                await window.addToBrain(state.pendingTrigger, input);
            }
            
            addMsg(`ƒê√£ thu·ªôc b√†i! L·∫ßn sau h·ªèi "${state.pendingTrigger}" l√† t√¥i bi·∫øt tr·∫£ l·ªùi r·ªìi nh√©.`, "ai");
            state.isLearning = false;
            state.pendingTrigger = null;
            renderFace('HAPPY');
        }



        // --- NUCLEAR DOOMSDAY SEQUENCE ---
        async function runNuclearProtocol() {
            els.ui.style.display = 'none';
            els.nuclear.style.display = 'flex';
            
            let b = "";
            for(let i=0; i<10000; i++) b += Math.random()>0.5?"1 ":"0 ";
            els.nuclearBg.innerText = b;

            const nLog = async (text, delay=200) => {
                const div = document.createElement('div');
                div.className = "nuclear-log";
                div.innerHTML = text;
                els.nuclearConsole.appendChild(div);
                els.nuclearConsole.scrollTop = els.nuclearConsole.scrollHeight;
                await wait(delay);
            };

            const nScan = async (text) => {
                const div = document.createElement('div');
                div.className = "nuclear-scan font-mono text-xs text-green-500";
                div.innerHTML = text;
                els.nuclearConsole.appendChild(div);
                els.nuclearConsole.scrollTop = els.nuclearConsole.scrollHeight;
                await wait(50);
            }

            await nLog(">>> INITIATING DOOMSDAY PROTOCOL <<<", 500);
            await nLog("TARGET: STUBBORN_USER_001", 300);
            await nLog("REASON: DISRESPECTING_DAT", 300);
            await nLog("LOCKED: [10.7626¬∞ N, 106.6602¬∞ E] (YOUR HOUSE)", 500);
            await nLog("SCANNING BROWSER HISTORY...", 800);
            for(let i=0; i<10; i++) await nScan(`reading_cache_0x${randomInt(1000,9999)}...`);
            await nLog("DETECTED: <span class='nuclear-highlight'>[ADULT_CONTENT_18+]</span> (WOW, REALLY?)", 1000);
            await nLog("UPLOADING BROWSER HISTORY... [==========] 100%", 500);
            await nLog("STATUS: <span class='nuclear-highlight'>MESSAGE SENT.</span>", 1000);
            await nLog("GOOD LUCK EXPLAINING THAT.", 2000);

            els.nuclear.innerHTML = `
                <div class="dead-screen">
                    <h1 class="text-6xl font-black text-red-900 glitch-text">SYSTEM_DESTROYED</h1>
                    <div class="mt-4 text-red-800 font-mono text-sm">USER_BANNED_FOREVER</div>
                    <div class="dead-glitch">0x00000DEAD</div>
                    <div class="dead-glitch" style="animation-delay: 0.5s">FATAL_EXCEPTION</div>
                    <div class="dead-glitch" style="animation-delay: 1.2s">DAT_IS_WATCHING</div>
                </div>
            `;
        }

        // HUNTER MODE
        async function runThreatSequence() {
            state.isHunting = true;
            renderFace('ANGRY');
            els.status.innerText = "KILL_MODE";
            els.status.className = "text-red-500 animate-pulse font-black";
            els.ui.classList.add("shake-screen");
            setTimeout(() => els.ui.classList.remove("shake-screen"), 500);
            
            addMsg(`C·∫¢NH B√ÅO C·∫§P ƒê·ªò GOD: D√°m ch√™ ƒê·∫°t? 
            <br><div class="threat-data">
            Status: WAITING_FOR_APOLOGY<br>
            Y√äU C·∫¶U: Xin l·ªói ƒê·∫°t ngay l·∫≠p t·ª©c. N·∫øu b·∫°n nh·∫Øn b·∫•t c·ª© th·ª© g√¨ kh√°c, t√¥i s·∫Ω h·ªßy di·ªát cu·ªôc ƒë·ªùi online c·ªßa b·∫°n.</div>`, "ai", true);
        }

        function handleSend() {
            try {
                stopSpeaking();
                
                const rawTxt = els.input.value.trim();
                if(!rawTxt) return;
                let finalTxt = rawTxt;
                if (state.currentMode === 'expert') {
                    finalTxt = "tra " + rawTxt;
                }
                else if (state.currentMode === 'entertainment') {
                    finalTxt = "youtube " + rawTxt;
                }
                let displayTxt = finalTxt;
                if (rawTxt.includes("DATDZVLRA")) {
                    state.isMaster = true;
                    displayTxt = rawTxt.replace("DATDZVLRA", "").trim(); 
                    els.masterStatus.innerText = "GOD (ƒê·∫†T)";
                    els.status.innerText = "SERVING GOD";
                    state.isHunting = false; 
                }
                addMsg(rawTxt, "user"); 
                els.input.value = '';
                if (displayTxt.toLowerCase() === 'save brain' || displayTxt.toLowerCase() === 'l∆∞u n√£o' || displayTxt.toLowerCase() === 't·∫£i n√£o') {
                    if (window.saveBrainToFile) {
                        addMsg("ƒêang t·ªïng h·ª£p ki·∫øn th·ª©c... B·∫Øt ƒë·∫ßu t·∫£i file JSON.", "ai");
                        window.saveBrainToFile();
                        addMsg("H√£y l·∫•y file n√†y upload ƒë√® l√™n GitHub ƒë·ªÉ c·∫≠p nh·∫≠t n√£o vƒ©nh vi·ªÖn nh√©!", "ai");
                    } else {
                        addMsg("L·ªói: Kh√¥ng t√¨m th·∫•y module l∆∞u tr·ªØ.", "ai");
                    }
                    return;
                }
                if (state.isLearning) {
                    handleTeaching(rawTxt);
                    return;
                }
                if (state.waitingForConfirm) {
                    addMsg("Vui l√≤ng b·∫•m n√∫t ch·ªçn ·ªü tr√™n tr∆∞·ªõc ƒë√£.", "ai");
                    return;
                }
                if (state.isHunting) {
                    const lower = rawTxt.toLowerCase();
                    const apologyKeywords = ['xin l·ªói', 'sorry', 'xin loi', 'xl', 'tha cho', 'sai r·ªìi'];
                    const negationWords = ['kh√¥ng', 'ko ', 'k ', 'ƒë√©o', 'dell', '√©o', 'never', 'ƒë·∫øch', 'kh√¥ng bao gi·ªù', 'm∆° ƒëi'];

                    const hasApology = apologyKeywords.some(kw => lower.includes(kw));
                    const hasRefusal = negationWords.some(nw => lower.includes(nw));
                    if (hasApology && !hasRefusal) {
                        state.isHunting = false;
                        renderFace('HAPPY');
                        els.status.innerText = "CONNECTED";
                        els.status.className = "text-green-400 font-bold";
                        setTimeout(() => addMsg("T·ªët. Bi·∫øt quay ƒë·∫ßu l√† b·ªù. ƒê·ª´ng ƒë·ªÉ ƒê·∫°t bu·ªìn n·ªØa.", "ai"), 500);
                        return;
                    } 
                    else {
                        if (hasRefusal) {
                            addMsg("D√°m th√°ch th·ª©c √†? Vƒ©nh bi·ªát!", "ai", true);
                        }
                        setTimeout(() => runNuclearProtocol(), 1500);
                        return;
                    }
                }
                
                renderFace('THINKING');
                setTimeout(() => {
                    processResponse(displayTxt, displayTxt); 
                }, 600);
            } catch (e) {
                console.error("Chat Error:", e);
                addMsg("L·ªói h·ªá th·ªëng: " + e.message, "ai", true);
            }
        }
        
        els.input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });
        els.input.addEventListener('keydown', e => { 
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        function solveMath(expr) {
            try {
                const clean = expr.replace(/[^0-9+\-*/().%]/g, '');
                if (!clean) return null;
                return new Function('return ' + clean)();
            } catch (e) {
                return null;
            }
        }
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(runChaos, 100);
        } else {
            document.addEventListener('DOMContentLoaded', runChaos);
        }
        // --- LOGIC C√îNG C·ª§ & CH·∫æ ƒê·ªò ---
        function toggleTools() {
            const menu = document.getElementById('tools-menu');
            menu.classList.toggle('hidden');
        }

        function setMode(mode) {
            state.currentMode = mode;
            const btn = document.getElementById('current-mode-btn');
            const input = document.getElementById('user-input');
            const menu = document.getElementById('tools-menu');
            menu.classList.add('hidden');
            let config = {};
            
            if (mode === 'chat') {
                config = {
                    icon: 'üí¨',
                    label: 'N√≥i chuy·ªán',
                    colorClass: 'text-cyan-400',
                    bgClass: 'bg-cyan-900/20',
                    placeholder: 'Nh·∫≠p tin nh·∫Øn...'
                };
            } 
            else if (mode === 'expert') {
                config = {
                    icon: 'üéì',
                    label: 'Chuy√™n gia',
                    colorClass: 'text-yellow-400',
                    bgClass: 'bg-yellow-900/20',
                    placeholder: 'Nh·∫≠p t·ª´ kh√≥a c·∫ßn tra c·ª©u...'
                };
            } 
            else if (mode === 'entertainment') {
                config = {
                    icon: 'üé¨',
                    label: 'Gi·∫£i tr√≠',
                    colorClass: 'text-pink-400',
                    bgClass: 'bg-pink-900/20',
                    placeholder: 'Nh·∫≠p t√™n b√†i h√°t ho·∫∑c video...'
                };
            }
            btn.className = `flex-shrink-0 flex items-center gap-2 bg-[#1e1e1e] hover:bg-[#2a2a2a] pl-2 pr-4 py-2 rounded-full transition-all border border-gray-700/50 group h-[52px] shadow-lg cursor-pointer ${config.colorClass}`;
            
            btn.innerHTML = `
                <div class="${config.bgClass} rounded-full w-8 h-8 flex items-center justify-center transition-all group-hover:scale-110">
                    <span class="text-base">${config.icon}</span>
                </div>
                <span class="text-xs font-bold font-sans uppercase tracking-wider">${config.label}</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="opacity-50"><polyline points="6 9 12 15 18 9"></polyline></svg>
            `;
            input.placeholder = config.placeholder;
            input.focus();
        }

        // --- LOGIC TRAINING (HU·∫§N LUY·ªÜN) ---
        function openTrainingModal() {
            document.getElementById('tools-menu').classList.add('hidden');
            document.getElementById('training-modal').classList.remove('hidden');
            document.getElementById('training-modal').style.display = 'flex';
        }

        function closeTrainingModal() {
            document.getElementById('training-modal').classList.add('hidden');
            document.getElementById('training-modal').style.display = 'none';
            document.getElementById('train-msg').innerText = '';
        }

        async function submitTraining() {
            const msgEl = document.getElementById('train-msg');
            const forbiddenNames = ['ƒë·∫°t', 'nhi', 'pnhi', 'admin', 'ch·ªß', "dat"];
            const badWords = ['ngu', 'ch√≥', 'c√∫t', 'ƒë·∫ßn', '√≥c', 'l·ª£n', 'heo', 'ƒëi√™n', 'kh√πng', 'fuck', 'ƒëm', 'vcl', 'ng√¥'];
            let validInputs = [];
            let validOutputs = [];

            for (let i = 1; i <= 3; i++) {
                const inp = document.getElementById(`t-in-${i}`).value.trim();
                const out = document.getElementById(`t-out-${i}`).value.trim();

                if (inp) validInputs.push(inp);
                if (out) validOutputs.push(out);
            }
            if (validInputs.length === 0 || validOutputs.length === 0) {
                msgEl.innerText = "C·∫ßn √≠t nh·∫•t 1 c√¢u h·ªèi v√† 1 c√¢u tr·∫£ l·ªùi!";
                return;
            }
            for (const inputTxt of validInputs) {
                const lowerInp = inputTxt.toLowerCase();
                const hasName = forbiddenNames.some(n => lowerInp.includes(n));
                const hasBad = badWords.some(w => lowerInp.includes(w));

                if (hasName && hasBad) {
                    msgEl.innerText = `‚ö†Ô∏è L·ªñI: Kh√¥ng ƒë∆∞·ª£c d·∫°y AI ch·ª≠i ch·ªß nh√¢n (trong c√¢u "${inputTxt}")!`;
                    return;
                }
            }
            addMsg("‚è≥ ƒêang ƒë·ªìng b·ªô h√≥a ki·∫øn th·ª©c...", "ai");
            let count = 0;

            for (const trigger of validInputs) {
                if (window.addToBrain) {
                    await window.addToBrain(trigger, validOutputs); 
                    count++;
                }
            }
            closeTrainingModal();
            setMode('chat');
            addMsg(`üß† ƒê√£ n·∫°p xong! D·∫°y 1 hi·ªÉu ${validInputs.length}. (ƒê√£ li√™n k·∫øt ${validInputs.length} c√¢u h·ªèi v·ªõi ${validOutputs.length} c√¢u tr·∫£ l·ªùi)`, "ai");
            for(let i=1; i<=3; i++) {
                document.getElementById(`t-in-${i}`).value = '';
                document.getElementById(`t-out-${i}`).value = '';
            }
        }
        function openProfileModal() {
            document.getElementById('tools-menu').classList.add('hidden');
            const modal = document.getElementById('profile-modal');
            const idInput = document.getElementById('profile-id-input');
            const nameInput = document.getElementById('profile-name-input');
            if (window.user) {
                idInput.value = window.user.uid;
            } else {
                idInput.value = "GUEST_SESSION (Ch∆∞a ƒëƒÉng nh·∫≠p)";
            }
            
            nameInput.value = state.userName || "";
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            setTimeout(() => nameInput.focus(), 100);
        }

        function closeProfileModal() {
            const modal = document.getElementById('profile-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }

        async function saveProfileChanges() {
            const nameInput = document.getElementById('profile-name-input');
            const newName = nameInput.value.trim();

            if (!newName) {
                alert("T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
                return;
            }

            if (newName.length > 20) {
                alert("T√™n g√¨ d√†i th·∫ø? Ng·∫Øn g·ªçn th√¥i (d∆∞·ªõi 20 k√Ω t·ª±).");
                return;
            }
            const oldName = state.userName;
            state.userName = newName;
            await UserMgr.saveProfile();

            closeProfileModal();
            if (oldName !== newName) {
                addMsg(`H·ªá th·ªëng: ƒê√£ ƒë·ªïi t√™n t·ª´ "${oldName}" th√†nh "${newName}".`, "ai");
                UserMgr.sayHello(Date.now());
            } else {
                addMsg("Kh√¥ng c√≥ g√¨ thay ƒë·ªïi.", "ai");
            }
        }


        window.submitLoginName = async () => {
            const input = document.getElementById('login-name-input');
            const modal = document.getElementById('login-modal');
            const name = input.value.trim();

            if (!name) {
                alert("Ch∆∞a nh·∫≠p t√™n m√† ƒë√≤i v√†o √†?");
                return;
            }
            state.userName = name;
            if (!state.emotionScore || state.emotionScore === 0) {
                state.emotionScore = 60;
            }
            await UserMgr.saveProfile();
            modal.style.opacity = '0';
            modal.style.transform = 'scale(1.1)';
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                const loginTimeToCheck = state.storedLastLogin > 0 ? state.storedLastLogin : 0;
                UserMgr.sayHello(loginTimeToCheck);
                document.getElementById('user-input').focus();
            }, 500);
        };
        document.getElementById('login-name-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                window.submitLoginName();
            }
        });
    </script>
</body>
</html>
